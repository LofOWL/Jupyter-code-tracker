[{"block": 0, "type": "markdown", "linesLength": 1, "startIndex": 0, "lines": ["<span style=\"float:left;\">Licence CC BY-NC-ND</span><span style=\"float:right;\">Thierry Parmentelat &amp; Arnaud Legout&nbsp;<img src=\"media/inria-25-alpha.png\" style=\"display:inline\"></span><br/>"]}, {"block": 1, "type": "markdown", "linesLength": 1, "startIndex": 1, "lines": ["# Boucles d'\u00e9v\u00e9nements"]}, {"block": 2, "type": "markdown", "linesLength": 1, "startIndex": 2, "lines": ["[`asyncio.get_event_loop().run_complete(<future>)`](https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.AbstractEventLoop.run_until_complete)"]}, {"block": 3, "type": "markdown", "linesLength": 5, "startIndex": 3, "lines": ["```\n", "asyncio.get_event_loop().run_complete(\n", "    asyncio.gather(coro1, coro2, ...)\n", "))\n", "```"]}, {"block": 4, "type": "markdown", "linesLength": 1, "startIndex": 8, "lines": ["## Ajout de traitements"]}, {"block": 5, "type": "markdown", "linesLength": 4, "startIndex": 9, "lines": ["`asyncio.ensure_future(coro)`\n", "\n", "* pour ajouter une coroutine dans la boucle\n", "* avant ou apr\u00e8s le lancement de la boucle"]}, {"block": 6, "type": "markdown", "linesLength": 1, "startIndex": 13, "lines": ["[`asyncio.get_event_loop().run_forever()`](https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.AbstractEventLoop.run_forever)"]}, {"block": 7, "type": "markdown", "linesLength": 1, "startIndex": 14, "lines": ["# Utilitaire #1"]}, {"block": 8, "type": "code", "linesLength": 1, "startIndex": 15, "lines": ["from asynchelpers import start_time, show_time"]}, {"block": 9, "type": "code", "linesLength": 5, "startIndex": 16, "lines": ["import time\n", "\n", "start_time()\n", "time.sleep(0.5)\n", "show_time('un message')"]}, {"block": 10, "type": "markdown", "linesLength": 1, "startIndex": 21, "lines": ["# Utilitaire #2"]}, {"block": 11, "type": "code", "linesLength": 6, "startIndex": 22, "lines": ["import asyncio\n", "\n", "async def sequence(*messages, delay=1):\n", "    show_time(\">>>\", *messages)\n", "    await asyncio.sleep(delay)\n", "    show_time(\"<<<\", *messages)"]}, {"block": 12, "type": "markdown", "linesLength": 1, "startIndex": 28, "lines": ["# Boucle sans fin"]}, {"block": 13, "type": "code", "linesLength": 5, "startIndex": 29, "lines": ["import asyncio\n", "\n", "loop = asyncio.get_event_loop()\n", "asyncio.ensure_future(sequence('foo', delay=0.5))\n", "asyncio.ensure_future(sequence('bar', delay=1))"]}, {"block": 14, "type": "code", "linesLength": 6, "startIndex": 34, "lines": ["# on lance la boucle sans fin\n", "# interrompre aver Kernel -> Interrupt (ou raccourci 'i')\n", "try:\n", "    asyncio.get_event_loop().run_forever()\n", "except KeyboardInterrupt as e:\n", "    print(\"bye\")"]}, {"block": 15, "type": "markdown", "linesLength": 1, "startIndex": 40, "lines": ["# `run_until_complete` vs `run_forever`"]}, {"block": 16, "type": "markdown", "linesLength": 4, "startIndex": 41, "lines": ["* `run_until_complete`\n", "\n", "   * prend exactement un argument\n", "   * retourne la valeur\n"]}, {"block": 17, "type": "markdown", "linesLength": 4, "startIndex": 45, "lines": ["* `run_forever`\n", "  * ne prend pas d'argument\n", "  * ne retourne pas\n", "  * orient\u00e9 traitement massivement asynchrone"]}, {"block": 18, "type": "markdown", "linesLength": 1, "startIndex": 49, "lines": ["# `get_event_loop()`"]}, {"block": 19, "type": "markdown", "linesLength": 3, "startIndex": 50, "lines": ["* `get_event_loop()` \n", "  * boucle par d\u00e9faut du thread courant\n", "  * ne *cr\u00e9e pas* de boucle en dehors du thread principal"]}, {"block": 20, "type": "markdown", "linesLength": 1, "startIndex": 53, "lines": ["# `{set,new}_event_loop()`"]}, {"block": 21, "type": "code", "linesLength": 5, "startIndex": 54, "lines": ["# loop = asyncio.new_event_loop()\n", "# asyncio.set_event_loop(loop)\n", "\n", "# ou encore tout simplement\n", "asyncio.set_event_loop(asyncio.new_event_loop())"]}, {"block": 22, "type": "markdown", "linesLength": 1, "startIndex": 59, "lines": ["## Ajout de traitements \u00e0 la vol\u00e9e (*fork*)"]}, {"block": 23, "type": "markdown", "linesLength": 1, "startIndex": 60, "lines": ["![fork](w9-s5-av-fig1.png)"]}, {"block": 24, "type": "code", "linesLength": 6, "startIndex": 61, "lines": ["# c1 et c3 sont tr\u00e8s simples\n", "async def c1():\n", "    await sequence(\"c1\", delay=2)\n", "\n", "async def c3():\n", "    await sequence(\"c3\", delay=2)    "]}, {"block": 25, "type": "markdown", "linesLength": 1, "startIndex": 67, "lines": ["![fork](w9-s5-av-fig1.png)"]}, {"block": 26, "type": "code", "linesLength": 7, "startIndex": 68, "lines": ["async def c2():\n", "    show_time('>>> c2')\n", "    await asyncio.sleep(1)\n", "    show_time('=== ensure_future')\n", "    asyncio.ensure_future(c3())\n", "    await asyncio.sleep(1)\n", "    show_time('<<< c2')"]}, {"block": 27, "type": "markdown", "linesLength": 1, "startIndex": 75, "lines": ["# *fork* avec `ensure_future`"]}, {"block": 28, "type": "code", "linesLength": 9, "startIndex": 76, "lines": ["# interrompre apr\u00e8s 3s\n", "asyncio.ensure_future(c1())\n", "asyncio.ensure_future(c2())\n", "\n", "start_time()\n", "try:\n", "   asyncio.get_event_loop().run_forever()\n", "except:\n", "    print('interrupted')"]}, {"block": 29, "type": "markdown", "linesLength": 1, "startIndex": 85, "lines": ["![fork](w9-s5-av-fig1.png)"]}, {"block": 30, "type": "markdown", "linesLength": 1, "startIndex": 86, "lines": ["# `run_{until_complete,forever}`"]}, {"block": 31, "type": "code", "linesLength": 2, "startIndex": 87, "lines": ["asyncio.set_event_loop(\n", "    asyncio.new_event_loop())"]}, {"block": 32, "type": "code", "linesLength": 6, "startIndex": 89, "lines": ["async def c1():\n", "    await sequence('c1', delay=1)\n", "async def c2():\n", "    await sequence('c2', delay=2)\n", "async def c3():\n", "    await sequence('c3', delay=3)"]}, {"block": 33, "type": "code", "linesLength": 8, "startIndex": 95, "lines": ["loop = asyncio.get_event_loop()\n", "\n", "asyncio.ensure_future(c1())\n", "asyncio.ensure_future(c3())\n", "\n", "start_time()\n", "loop.run_until_complete(c2())\n", "print(\"done 1\")"]}, {"block": 34, "type": "code", "linesLength": 5, "startIndex": 103, "lines": ["# interrompre apr\u00e8s 1\n", "try:\n", "    loop.run_forever()\n", "except:\n", "    print(\"interrupted\")"]}, {"block": 35, "type": "markdown", "linesLength": 1, "startIndex": 108, "lines": ["# R\u00e9sum\u00e9"]}, {"block": 36, "type": "markdown", "linesLength": 3, "startIndex": 109, "lines": ["* `get_event_loop()` \n", "  * acc\u00e9de \u00e0 la boucle courante\n", "  * `new_event_loop()` et `set_event_loop()`"]}, {"block": 37, "type": "markdown", "linesLength": 1, "startIndex": 112, "lines": ["* `ensure_future()`"]}, {"block": 38, "type": "markdown", "linesLength": 1, "startIndex": 113, "lines": ["* `run_until_complete()` et `run_forever()`"]}]
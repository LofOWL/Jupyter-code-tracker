[{"block": 0, "type": "heading", "linesLength": 1, "startIndex": 0, "lines": ["Surcharge op\u00e9rateurs (2)"]}, {"block": 1, "type": "heading", "linesLength": 1, "startIndex": 1, "lines": ["Compl\u00e9ment - niveau avanc\u00e9"]}, {"block": 2, "type": "markdown", "linesLength": 1, "startIndex": 2, "lines": ["Nous poursuivons dans ce compl\u00e9ment la s\u00e9lection de m\u00e9thodes sp\u00e9ciales entreprise en premi\u00e8re partie."]}, {"block": 3, "type": "markdown", "linesLength": 1, "startIndex": 3, "lines": ["***"]}, {"block": 4, "type": "heading", "linesLength": 1, "startIndex": 4, "lines": ["`__contains__`, `__len__`, `__getitem__` et apparent\u00e9s"]}, {"block": 5, "type": "markdown", "linesLength": 5, "startIndex": 5, "lines": ["La m\u00e9thode `__contains__` permet de donner un sens \u00e0&nbsp;:\n", "\n", "    item in objet\n", "    \n", "Sans grande surprise, elle prend en argument un objet et un item, et doit renvoyer un bool\u00e9en. Nous l'illustrons ci-dessous avec la classe `DualQueue`."]}, {"block": 6, "type": "markdown", "linesLength": 1, "startIndex": 10, "lines": ["La m\u00e9thode `__len__` est utilis\u00e9e par la fonction *builtin* `len` pour retourner la longueur d'un objet. "]}, {"block": 7, "type": "heading", "linesLength": 1, "startIndex": 11, "lines": ["La classe `DualQueue`"]}, {"block": 8, "type": "markdown", "linesLength": 3, "startIndex": 12, "lines": ["Nous allons illustrer ceci avec un exemple de classe, un peu artificiel, qui impl\u00e9mente une queue de type FIFO. Les objets sont d'abord admis dans la file d'entr\u00e9e (`add_input`), puis d\u00e9plac\u00e9s dans la file de sortie (`move_input_to_output`), et enfin sortis (`emit_output`).\n", "\n", "Clairement, cet exemple est \u00e0 but uniquement p\u00e9dagogique; on veut montrer comment une impl\u00e9mentation qui repose sur deux listes s\u00e9par\u00e9es peut donner l'illusion d'une continuit\u00e9, et se pr\u00e9senter comme un container unique. De plus cette impl\u00e9mentation ne fait aucun contr\u00f4le pour ne pas obscurcir le code. "]}, {"block": 9, "type": "heading", "linesLength": 1, "startIndex": 15, "lines": ["Longueur et appartenance"]}, {"block": 10, "type": "markdown", "linesLength": 1, "startIndex": 16, "lines": ["Avec cette premi\u00e8re version de la classe `DualQueue` on peut utiliser `len` et le test d'appartenance&nbsp;:"]}, {"block": 11, "type": "heading", "linesLength": 1, "startIndex": 17, "lines": ["Acc\u00e8s s\u00e9quentiel (acc\u00e8s par un index entier)"]}, {"block": 12, "type": "markdown", "linesLength": 5, "startIndex": 18, "lines": ["Lorsqu'on a la notion de longueur de l'objet avec  `__len__`, il peut \u00eatre opportun -  quoique cela n'est pas impos\u00e9 par le langage, comme on vient de le voir - de proposer \u00e9galement un acc\u00e8s index\u00e9 par un entier pour pouvoir faire&nbsp;:\n", "\n", "    queue[1]\n", "    \n", "**Pour ne pas r\u00e9p\u00e9ter tout le code de la classe**, nous allons \u00e9tendre `DualQueue`; pour cela nous d\u00e9finissons une fonction, que nous affectons ensuite \u00e0 `DualQueue.__getitem__`, comme nous avons d\u00e9j\u00e0 eu l'occasion de le faire&nbsp;:"]}, {"block": 13, "type": "markdown", "linesLength": 1, "startIndex": 23, "lines": ["\u00c0 pr\u00e9sent, on peut **acc\u00e9der** aux objets de la queue **s\u00e9quentiellement**&nbsp;:"]}, {"block": 14, "type": "markdown", "linesLength": 1, "startIndex": 24, "lines": ["ce qui l\u00e8ve la m\u00eame exception qu'avec une vraie liste si on utilise un mauvais index&nbsp;:"]}, {"block": 15, "type": "heading", "linesLength": 1, "startIndex": 25, "lines": ["Am\u00e9lioration : acc\u00e8s par slice"]}, {"block": 16, "type": "markdown", "linesLength": 5, "startIndex": 26, "lines": ["Si on veut aussi supporter l'acc\u00e8s par slice comme ceci&nbsp;:\n", "\n", "    queue[1:3]\n", "    \n", "il nous faut modifier la m\u00e9thode `__getitem__`. "]}, {"block": 17, "type": "markdown", "linesLength": 1, "startIndex": 31, "lines": ["Le second argument de `__getitem__` correspond naturellement au contenu des crochets `[]`, on utilise donc `isinstance` pour \u00e9crire un code qui s'adapte au type d'indexation, comme ceci&nbsp;:"]}, {"block": 18, "type": "markdown", "linesLength": 1, "startIndex": 32, "lines": ["Maintenant on peut acc\u00e9der par slice"]}, {"block": 19, "type": "markdown", "linesLength": 1, "startIndex": 33, "lines": ["Et on re\u00e7oit bien une exception si on essaie d'acc\u00e9der par cl\u00e9&nbsp;:"]}, {"block": 20, "type": "heading", "linesLength": 1, "startIndex": 34, "lines": ["L'objet est it\u00e9rable (m\u00eame sans avoir `__iter__`)"]}, {"block": 21, "type": "markdown", "linesLength": 1, "startIndex": 35, "lines": ["Avec seulement `__len__` et `__getitem__`, on peut **faire une boucle** sur l'objet queue. On l'a mentionn\u00e9 rapidement dans la s\u00e9quence sur les it\u00e9rateurs, mais la **m\u00e9thode `__iter__` n'est pas la seule fa\u00e7on** de rendre un objet it\u00e9rable&nbsp;:"]}, {"block": 22, "type": "heading", "linesLength": 1, "startIndex": 36, "lines": ["On peut faire un test sur l'objet"]}, {"block": 23, "type": "markdown", "linesLength": 1, "startIndex": 37, "lines": ["De mani\u00e8re similaire, m\u00eame sans la m\u00e9thode `__nonzero__`, cette classe sait **faire des tests de mani\u00e8re correcte** gr\u00e2ce uniquement \u00e0 la m\u00e9thode `__len__`&nbsp;:"]}, {"block": 24, "type": "markdown", "linesLength": 1, "startIndex": 38, "lines": ["***"]}, {"block": 25, "type": "heading", "linesLength": 1, "startIndex": 39, "lines": ["`__call__` et les *callables*"]}, {"block": 26, "type": "markdown", "linesLength": 2, "startIndex": 40, "lines": ["Le langage introduit de mani\u00e8re similaire la notion de ***callable*** - litt\u00e9ralement, qui peut \u00eatre appel\u00e9.\n", "L'id\u00e9e est tr\u00e8s simple, on cherche \u00e0 donner un sens \u00e0 un fragment de code du genre de&nbsp;:"]}, {"block": 27, "type": "raw", "linesLength": 5, "startIndex": 42, "lines": ["# on cr\u00e9e une instance\n", "objet = Classe(arguments)\n", "\n", "# et c'est l'objet (et pas la classe) qu'on utilise comme une fonction\n", "objet(arg1, arg2)"]}, {"block": 28, "type": "markdown", "linesLength": 3, "startIndex": 47, "lines": ["Le protocole ici est tr\u00e8s simple; cette derni\u00e8re ligne a un sens en python d\u00e8s lors que&nbsp;:\n", " * `objet` poss\u00e8de une m\u00e9thode `__call__`,\n", " * et que celle-ci peut \u00eatre envoy\u00e9e \u00e0 `objet` avec les arguments `arg1, arg2`, pour nous donner le r\u00e9sultat qui sera retourn\u00e9 par `objet(arg1, arg2)`."]}, {"block": 29, "type": "raw", "linesLength": 1, "startIndex": 50, "lines": ["objet(arg1, arg2)   ===>   objet.__call__(arg1, arg2)"]}, {"block": 30, "type": "markdown", "linesLength": 1, "startIndex": 51, "lines": ["Voyons cela sur un exemple&nbsp;:"]}, {"block": 31, "type": "markdown", "linesLength": 1, "startIndex": 52, "lines": ["Pour ceux qui connaissent, nous avons choisi \u00e0 dessein un exemple qui s'apparente \u00e0 [une cl\u00f4ture](http://en.wikipedia.org/wiki/Closure_%28computer_programming%29). Nous reviendrons sur cette notion de *callable* lorsque nous verrons les d\u00e9corateurs en semaine 7. "]}, {"block": 32, "type": "markdown", "linesLength": 1, "startIndex": 53, "lines": ["***"]}, {"block": 33, "type": "heading", "linesLength": 1, "startIndex": 54, "lines": ["`__getattr__` et apparent\u00e9s"]}, {"block": 34, "type": "markdown", "linesLength": 3, "startIndex": 55, "lines": ["Dans cette derni\u00e8re partie nous allons voir comment avec la m\u00e9thode `__getattr__`, on peut red\u00e9finir la fa\u00e7on que le langage a d'\u00e9valuer\n", "\n", "    objet.attribut"]}, {"block": 35, "type": "markdown", "linesLength": 1, "startIndex": 58, "lines": ["**Avertissement:** on a vu dans la s\u00e9quence consacr\u00e9e \u00e0 l'h\u00e9ritage que, pour l'essentiel, le m\u00e9canisme d'h\u00e9ritage repose **pr\u00e9cis\u00e9ment** sur la fa\u00e7on d'\u00e9valuer les attributs d'un objet, aussi nous vous recommandons d'utiliser ce trait avec pr\u00e9caution, car il vous donne la possibilit\u00e9 de \"faire muter le langage\" comme on dit."]}, {"block": 36, "type": "heading", "linesLength": 1, "startIndex": 59, "lines": ["Un exemple : la classe `RPCProxy`"]}, {"block": 37, "type": "markdown", "linesLength": 8, "startIndex": 60, "lines": ["Pour illustrer `__getattr__`, nous allons consid\u00e9rer le probl\u00e8me suivant. Une application utilise un service distant, avec laquelle elle interagit au travers d'une API.\n", "\n", "C'est une situation tr\u00e8s fr\u00e9quente: lorsqu'on utilise un service m\u00e9t\u00e9o, ou de g\u00e9olocalisation, ou de r\u00e9servation, le prestataire vous propose une **API** (Application Programming Interface) qui se pr\u00e9sente bien souvent comme une **liste de fonctions**, que votre fonction peut appeler \u00e0 distance au travers d'un m\u00e9canisme de **RPC** (Remote Procedure Call).\n", "\n", "Imaginez pour fixer les id\u00e9es que vous utilisez un service de r\u00e9servation de ressources dans un Cloud, qui vous permet d'appeler les fonctions suivantes&nbsp;:\n", " * `GetNodes`(...) pour obtenir des informations sur les noeuds disponibles,\n", " * `BookNode`(...) pour r\u00e9server un noeud,\n", " * `ReleaseNode`(...) pour abandonner un noeud."]}, {"block": 38, "type": "markdown", "linesLength": 3, "startIndex": 68, "lines": ["Naturellement ceci est une API extr\u00eamement simplifi\u00e9e. Le point que nous voulons illustrer ici est que le dialogue avec le service distant&nbsp;:\n", " * requiert ses propres donn\u00e9es - comme l'URL o\u00f9 on peut joindre le service, et les identifiants \u00e0 utiliser pour s'authentifier,\n", " * et poss\u00e8de sa propre logique - dans le cas d'une authentification par session par exemple, il faut s'authentifier une premi\u00e8re fois avec un login/password, pour obtenir une session qu'on peut utiliser dans les appels suivants."]}, {"block": 39, "type": "markdown", "linesLength": 3, "startIndex": 71, "lines": ["Pour ces raisons il est naturel de concevoir une classe `RPCProxy` dans laquelle on va rassembler \u00e0 la fois ces donn\u00e9es et cette logique, pour soulager toute l'application de ces d\u00e9tails, comme on l'a illustr\u00e9 ci-dessous&nbsp;:\n", "\n", "<img src=\"media/rpcproxy.png\">"]}, {"block": 40, "type": "markdown", "linesLength": 5, "startIndex": 74, "lines": ["Pour impl\u00e9menter la plomberie li\u00e9e \u00e0 RPC, \u00e0 l'encodage et d\u00e9codage des donn\u00e9es, et qui sera interne \u00e0 la classe `RPCProxy`, on pourra en vraie grandeur utiliser des outils comme&nbsp;:\n", " * [`xmlrpclib`](https://docs.python.org/2/library/xmlrpclib.html) qui fait partie de la librairie standard, \n", " * ou pour JSON, une des nombreuses impl\u00e9mentations qu'un moteur de recherche vous exposera si vous cherchez `python rpc json`, comme par exemple [`json-rpc`](https://pypi.python.org/pypi/json-rpc/)\n", "\n", "Cela n'est toutefois pas notre sujet ici, et nous nous contenterons, dans notre code simplifi\u00e9, d'imprimer un message."]}, {"block": 41, "type": "heading", "linesLength": 1, "startIndex": 79, "lines": ["Une approche na\u00efve"]}, {"block": 42, "type": "markdown", "linesLength": 1, "startIndex": 80, "lines": ["Se pose donc la question de savoir quelle interface la classe `RPCProxy` doit offrir au reste du monde. Dans une premi\u00e8re version na\u00efve on pourrait \u00e9crire quelque chose comme&nbsp;:"]}, {"block": 43, "type": "markdown", "linesLength": 1, "startIndex": 81, "lines": ["Ainsi l'application utilise la classe de cette fa\u00e7on&nbsp;:"]}, {"block": 44, "type": "heading", "linesLength": 1, "startIndex": 82, "lines": ["Discussion"]}, {"block": 45, "type": "markdown", "linesLength": 7, "startIndex": 83, "lines": ["Quelques commentaires en vrac au sujet de cette approche&nbsp;:\n", "\n", " * l'interface est correcte; l'objet `rcp_proxy` se comporte bien comme un proxy, on a donn\u00e9 au programmeur l'illusion compl\u00e8te qu'il utilise une classe locale (sauf pour les performances bien entendu...);\n", " * la s\u00e9paration des r\u00f4les est raisonnable \u00e9galement, la classe RPCProxy n'a pas \u00e0 conna\u00eetre le d\u00e9tail de la signature de chaque m\u00e9thode, charge \u00e0 l'appelant d'utiliser l'API correctement;\n", " * par contre ce qui cloche, c'est que l'impl\u00e9mentation de la classe RPCProxy d\u00e9pend de la liste des fonctions expos\u00e9es par l'API; imaginez une API avec 100 ou 200 m\u00e9thodes, cela donne une d\u00e9pendance assez forte et surtout inutile;\n", "\n", " * enfin, nous avons escamot\u00e9 la n\u00e9cessit\u00e9 de faire de RPCProxy un [singleton](http://en.wikipedia.org/wiki/Singleton_pattern), mais c'est une toute autre histoire."]}, {"block": 46, "type": "heading", "linesLength": 1, "startIndex": 90, "lines": ["Une approche plus subtile"]}, {"block": 47, "type": "markdown", "linesLength": 1, "startIndex": 91, "lines": ["Pour obtenir une impl\u00e9mentation qui conserve toutes les qualit\u00e9s de la version na\u00efve, mais sans la n\u00e9cessit\u00e9 de d\u00e9finir une \u00e0 une toutes les fonctions de l'API, on peut tirer profit de `__getattr__`, comme dans cette deuxi\u00e8me version&nbsp;:"]}, {"block": 48, "type": "markdown", "linesLength": 1, "startIndex": 92, "lines": ["Qui est cette fois **totalement d\u00e9coupl\u00e9e** des d\u00e9tails de l'API, et qu'on peut utiliser exactement comme tout \u00e0 l'heure&nbsp;:"]}, {"block": 49, "type": "heading", "linesLength": 1, "startIndex": 93, "lines": ["Exercice"]}, {"block": 50, "type": "markdown", "linesLength": 1, "startIndex": 94, "lines": ["Les \u00e9tudiants courageux et/ou inspir\u00e9s peuvent s'amuser \u00e0 reprendre cette derni\u00e8re version de `RPCProxy`, mais en utilisant une classe de **callables** comme une *factory* pour g\u00e9n\u00e9rer les attributs."]}, {"block": 51, "type": "markdown", "linesLength": 1, "startIndex": 95, "lines": ["Nous ne proposons pas de correction en ligne mais vous pouvez simplement \u00e9valuer le m\u00eame code&nbsp;:"]}]
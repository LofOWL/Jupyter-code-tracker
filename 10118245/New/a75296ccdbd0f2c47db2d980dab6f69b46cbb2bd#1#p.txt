[{"block": 0, "type": "markdown", "linesLength": 1, "startIndex": 0, "lines": ["<span style=\"float:left;\">Licence CC BY-NC-ND</span><span style=\"float:right;\">Thierry Parmentelat &amp; Arnaud Legout&nbsp;<img src=\"media/inria-25-alpha.png\" style=\"display:inline\"></span><br/>"]}, {"block": 1, "type": "markdown", "linesLength": 1, "startIndex": 1, "lines": ["# It\u00e9rateur et performances"]}, {"block": 2, "type": "markdown", "linesLength": 1, "startIndex": 2, "lines": ["*XXXXXX Ce notebook est \u00e0 reprendre lorsque la structure du cours python3 sera plus clairement connue. Voir aussi ONGOING-py3.md XXXXXX*"]}, {"block": 3, "type": "markdown", "linesLength": 1, "startIndex": 3, "lines": ["## Compl\u00e9ment - niveau basique"]}, {"block": 4, "type": "markdown", "linesLength": 1, "startIndex": 4, "lines": ["Dans ce compl\u00e9ment, nous allons voir pourquoi il est bien souvent pref\u00e9rable d'utiliser un it\u00e9rateur comme sujet d'une boucle `for`, plut\u00f4t que d'it\u00e9rer sur une \u00e9num\u00e9ration explicite comme une liste."]}, {"block": 5, "type": "markdown", "linesLength": 3, "startIndex": 5, "lines": ["### Calculs non-instantan\u00e9s dans un notebook\n", "\n", "Si en manipulant les exemples vous lancez par erreur un calcul trop long, l'interpr\u00e9teur reste occup\u00e9 jusqu'\u00e0 en avoir fini avec ce calcul, et ne pourra pas \u00e9valuer d'autres cellules tant qu'il n'aura pas fini. Simulons \u00e7a avec un petit bout de programme qui attend b\u00eatement pendant 5 secondes."]}, {"block": 6, "type": "code", "linesLength": 2, "startIndex": 8, "lines": ["from time import sleep\n", "sleep(5)"]}, {"block": 7, "type": "markdown", "linesLength": 5, "startIndex": 10, "lines": ["Vous remarquez que pendant le temps du `sleep`, le nombre en face du label `In[]` est remplac\u00e9 par une \u00e9toile, qui indique que votre interpr\u00e9teur python est occup\u00e9.\n", "\n", "Si vous n'\u00eates pas assez patient pour attendre qu'il finisse, pensez \u00e0 faire, via les menus du notebook\n", "* *Kernel* \u2192 *Interrupt* pour interrompre le traitement, ou encore\n", "* *Kernel* \u2192 *Restart* pour red\u00e9marrer votre interpr\u00e9teur."]}, {"block": 8, "type": "markdown", "linesLength": 1, "startIndex": 15, "lines": ["### Utilitaire `%%timeit`"]}, {"block": 9, "type": "markdown", "linesLength": 1, "startIndex": 16, "lines": ["\u00c0 l'int\u00e9rieur d'un notebook, lorsqu'on a besoin de mesurer le temps d'ex\u00e9cution d'un fragment de code, il est pratique d'utiliser l'astuce suivante:"]}, {"block": 10, "type": "code", "linesLength": 3, "startIndex": 17, "lines": ["%%timeit\n", "for i in range(10**3):\n", "    j = i**2"]}, {"block": 11, "type": "markdown", "linesLength": 1, "startIndex": 20, "lines": ["La premi\u00e8re ligne de cette cellule utilise ce qu'on appelle une *magic* ipython, et elle permet de mesurer avec le module `timeit` le temps d'ex\u00e9cution du code dans le reste de la cellule."]}, {"block": 12, "type": "markdown", "linesLength": 7, "startIndex": 21, "lines": ["Dans mon environnement, apr\u00e8s avoir \u00e9valu\u00e9 cette cellule le syst\u00e8me m'affiche ceci:\n", "\n", "```\n", "310 \u00b5s \u00b1 6.44 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n", "```\n", "\n", "qui prend quelques secondes, car la mesure du temps est faite en ex\u00e9cutant le code plusieurs fois. Ici en l'occurrence le chiffre qui nous int\u00e9resse est le tout premier, qui nous dit que pour ex\u00e9cuter toute la boucle il nous a fallu en moyenne 310 \u00b5s."]}, {"block": 13, "type": "markdown", "linesLength": 1, "startIndex": 28, "lines": ["##### `%%timeit -n`"]}, {"block": 14, "type": "markdown", "linesLength": 1, "startIndex": 29, "lines": ["Nous utiliserons parfois l'option `-n` qui nous permet de fixer le nombre de fois o\u00f9 le code est ex\u00e9cut\u00e9, pour fluidifier le notebook, cela se pr\u00e9sente comme ceci:"]}, {"block": 15, "type": "code", "linesLength": 5, "startIndex": 30, "lines": ["%%timeit -n 10\n", "# sans rien pr\u00e9ciser \u00e7a prend vraiment longtemps\n", "# \u00e7a vous donne l'occasion de faire un Kernel .. Interrupt :)\n", "for i in range(10**5):\n", "    j = i**2"]}, {"block": 16, "type": "markdown", "linesLength": 1, "startIndex": 35, "lines": ["### Le module `time`"]}, {"block": 17, "type": "markdown", "linesLength": 1, "startIndex": 36, "lines": ["Une autre fa\u00e7on de mesurer les temps d'ex\u00e9cution, plus basique mais moins fiable que `timeit`, consiste \u00e0 utiliser la fonction `time.time()`, qui retourne l'heure de l'horloge interne, en secondes. On peut donc faire quelque chose comme:"]}, {"block": 18, "type": "code", "linesLength": 9, "startIndex": 37, "lines": ["from time import time\n", "# on enregistre l'heure au d\u00e9but\n", "debut = time()\n", "for i in range(10**5):\n", "    j = i**2\n", "# on enregistre l'heure \u00e0 la fin\n", "fin = time()\n", "# la dur\u00e9e observ\u00e9e: fin-debut\n", "print(f\"Dur\u00e9e observ\u00e9e {fin-debut}\")"]}, {"block": 19, "type": "markdown", "linesLength": 5, "startIndex": 46, "lines": ["xxx ICI - \u00e0 terminer\n", "\n", "en fait je ne suis pas tr\u00e8s s\u00fbr du point que je cherchais \u00e0 faire ici, c'\u00e9tait du python2 et on voulait dire aux gens d'utiliser xrange plut\u00f4t que range(), mais bon bien s\u00fbr...\n", "\n", "il faudrait repenser \u00e7a dans le contexte de la semaine 5 qui commence avec iteration / compr\u00e9hension"]}, {"block": 20, "type": "markdown", "linesLength": 1, "startIndex": 51, "lines": ["### `range` *vs* `xrange`"]}, {"block": 21, "type": "markdown", "linesLength": 1, "startIndex": 52, "lines": ["Reprenons notre comparaison entre boucles `for` sur liste et sur it\u00e9rateur. Pour cela, commen\u00e7ons par un cas tr\u00e8s simple. Nous avons vu d\u00e9j\u00e0 \u00e0 de nombreuses reprises la fonction `range`. Il existe \u00e9galement une fonction `xrange` qui renvoie un **it\u00e9rateur** \u00e9quivalent, et non pas une liste&nbsp;:"]}, {"block": 22, "type": "code", "linesLength": 5, "startIndex": 53, "lines": ["for i in range(3):\n", "    print('range', i)\n", "\n", "for i in range(3):\n", "    print('xrange', i)"]}, {"block": 23, "type": "markdown", "linesLength": 1, "startIndex": 58, "lines": ["### Quelle diff\u00e9rence alors ?"]}, {"block": 24, "type": "markdown", "linesLength": 1, "startIndex": 59, "lines": ["Imaginez maintenant qu'au lieu de 3 \u00e9l\u00e9ments on en ait beaucoup plus; nous allons exp\u00e9rimenter avec plusieurs tailles"]}, {"block": 25, "type": "code", "linesLength": 2, "startIndex": 60, "lines": ["# de 100.000 \u00e0 50 millions\n", "tailles = [10**5, 10**6, 10**7, 5*10**7]"]}, {"block": 26, "type": "markdown", "linesLength": 1, "startIndex": 62, "lines": ["Voyons le temps que prend uniquement la **construction** d'une grosse liste."]}, {"block": 27, "type": "code", "linesLength": 7, "startIndex": 63, "lines": ["import time\n", "\n", "for taille in tailles:\n", "    beg = time.time()\n", "    liste = list(range(taille))\n", "    end = time.time()\n", "    print(\"Cr\u00e9ation de la liste de taille {}: {}s\".format(taille,end-beg))"]}, {"block": 28, "type": "markdown", "linesLength": 1, "startIndex": 70, "lines": ["Si maintenant on construit un it\u00e9rateur \u00e9quivalent on mesure un temps beaucoup plus court:"]}, {"block": 29, "type": "code", "linesLength": 7, "startIndex": 71, "lines": ["import time\n", "\n", "for taille in tailles:\n", "    beg = time.time()\n", "    iterateur = range(taille)\n", "    end = time.time()\n", "    print(\"Cr\u00e9ation de l'it\u00e9rateur de taille {}: {}s\".format(taille,end-beg))"]}, {"block": 30, "type": "markdown", "linesLength": 1, "startIndex": 78, "lines": ["On peut voir que, en tendance, la **cr\u00e9ation d'un it\u00e9rateur** de type `xrange` est quasiment **instantan\u00e9e** quelle que soit la taille, alors que la cr\u00e9ation d'une liste \u00e9quivalente prend **un temps beaucoup plus important** et d'autant plus long que la liste est grande."]}, {"block": 31, "type": "markdown", "linesLength": 1, "startIndex": 79, "lines": ["### Ce qu'il faut retenir"]}, {"block": 32, "type": "markdown", "linesLength": 5, "startIndex": 80, "lines": ["Pour r\u00e9sumer ce compl\u00e9ment, retenez que&nbsp;: \n", "\n", " * la **construction d'une liste**, surtout si elle est tr\u00e8s longue, peut avoir un **co\u00fbt non n\u00e9gligeable** en temps et en m\u00e9moire;\n", " * c'est pourquoi il convient de s'efforcer de **ne cr\u00e9er une liste** que lorsque c'est **r\u00e9ellement n\u00e9cessaire**;\n", " * et dans tous les autres cas - c'est \u00e0 dire \u00e0 chaque fois que la liste n'est qu'un **accessoire de calcul**, et ne repr\u00e9sente pas une fin en soi - il faut **pr\u00e9f\u00e9rer** l'utilisation d'**it\u00e9rateurs**."]}, {"block": 33, "type": "markdown", "linesLength": 1, "startIndex": 85, "lines": ["## Compl\u00e9ment - niveau interm\u00e9diaire"]}, {"block": 34, "type": "markdown", "linesLength": 1, "startIndex": 86, "lines": ["### Allouer et initialiser de la m\u00e9moire prend du temps"]}, {"block": 35, "type": "markdown", "linesLength": 7, "startIndex": 87, "lines": ["Ce ph\u00e9nom\u00e8ne peut vous para\u00eetre surprenant si vous n'\u00eates pas familier avec l'informatique. \u00c0 premi\u00e8re vue, si on juge superficiellement, on peut se demander ce qui se passe. \n", "\n", "En fait, pour cr\u00e9er la liste des `taille` premiers entiers, il faut\n", " * d'abord allouer suffisamment de m\u00e9moire pour tous les ranger\n", " * et ensuite remplir les `taille` cases de la liste avec les valeurs\n", "\n", "Ces deux op\u00e9rations semblent banales, mais elles prennent n\u00e9anmoins un peu de temps, qui \u00e0 grande \u00e9chelle devient sensible, comme nous venons de l'exp\u00e9rimenter."]}, {"block": 36, "type": "markdown", "linesLength": 1, "startIndex": 94, "lines": ["### Un it\u00e9rateur est un objet minuscule"]}, {"block": 37, "type": "markdown", "linesLength": 3, "startIndex": 95, "lines": ["A contrario, un it\u00e9rateur du type `xrange` ne **contient presque rien**. Cela sera approfondi en semaine 6, mais pour anticiper un peu la fonction d'un iterateur `xrange` consiste uniquement \u00e0 m\u00e9moriser les param\u00e8tres de la boucle, et \u00e0 quelle \u00e9tape on en est rendu \u00e0 un moment donn\u00e9. \n", "\n", "Ce qui explique le temps tr\u00e8s faible, et constant en fonction de `taille`, que l'on a observ\u00e9 pour la cr\u00e9ation de nos it\u00e9rateurs."]}, {"block": 38, "type": "markdown", "linesLength": 1, "startIndex": 98, "lines": ["### Des it\u00e9rateurs pour tout"]}, {"block": 39, "type": "markdown", "linesLength": 9, "startIndex": 99, "lines": ["Au fur et \u00e0 mesure de l'\u00e9volution de python-2, on a petit \u00e0 petit ajout\u00e9 des utilitaires pour calculer des it\u00e9rateurs plut\u00f4t que des listes. C'est le cas par exemple avec les fonctions et m\u00e9thodes suivantes&nbsp;:\n", "\n", "<table>\n", "<tr> <th>Original</th>  <th>Am\u00e9lior\u00e9</th>  </tr>\n", "<tr> <td>`range`</td>  <td>`xrange`</td>  </tr>\n", "<tr> <td>`dict.keys`</td>  <td>`dict.iterkeys`</td>  </tr>\n", "<tr> <td>`dict.values`</td>  <td>`dict.itervalues`</td>  </tr>\n", "<tr> <td>`dict.items`</td>  <td>`dict.iteritems`</td>  </tr>\n", "</table>"]}, {"block": 40, "type": "markdown", "linesLength": 1, "startIndex": 108, "lines": ["### python-3"]}, {"block": 41, "type": "markdown", "linesLength": 3, "startIndex": 109, "lines": ["Parmi les grandes diff\u00e9rences entre python-2 et python-3, il y a ceci&nbsp;: pour toutes les m\u00e9thodes ci-dessus, la s\u00e9mantique est syt\u00e9matiquement de retourner un it\u00e9rateur. \n", "\n", "Ainsi en python-3, `range(10)` retourne un objet it\u00e9rateur. Et il n'y a pas de fonction `xrange`, sachant qu'on peut toujours construire une liste liste en appelant explicitement la fonction `list` comme ceci&nbsp;:"]}, {"block": 42, "type": "markdown", "linesLength": 16, "startIndex": 112, "lines": ["    ~ $ python3\n", "    Python 3.4.1 (default, Sep 20 2014, 19:44:17)\n", "    [GCC 4.2.1 Compatible Apple LLVM 5.1 (clang-503.0.40)] on darwin\n", "    Type \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n", "    >>>\n", "    >>> range(10)\n", "    range(0, 10)\n", "    >>>\n", "    >>> xrange(10)\n", "    Traceback (most recent call last):\n", "      File \"<stdin>\", line 1, in <module>\n", "    NameError: name 'xrange' is not defined\n", "    >>>\n", "    >>> list(range(10))\n", "    [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]\n", "    >>>"]}, {"block": 43, "type": "markdown", "linesLength": 1, "startIndex": 128, "lines": ["## Compl\u00e9ment - niveau avanc\u00e9"]}, {"block": 44, "type": "markdown", "linesLength": 1, "startIndex": 129, "lines": ["Pour finir, et pour revenir sur les mesures de performances, voici une astuce qui permet de lancer  de petits benchmarkes dans un terminal&nbsp;:"]}, {"block": 45, "type": "markdown", "linesLength": 2, "startIndex": 130, "lines": ["    $ python -m timeit 'liste=range(10**6)' 'for x in liste: x+1'\n", "    10 loops, best of 3: 50.5 msec per loop"]}, {"block": 46, "type": "markdown", "linesLength": 8, "startIndex": 132, "lines": ["Ceci met en jeu un certain nombre de choses nouvelles:\n", " * python avec l'option -m permet d'importer un module, en l'occurrence ici [le module `timeit`](https://docs.python.org/3/library/timeit.html);\n", " * avec cette forme on peut passer \u00e0 `timeit` plusieurs instructions; ici nous avons deux instructions, une pour initialiser `liste`, la seconde pour lancer la boucle `for`;\n", " * il est possible d'\u00e9crire des instructions sur une seule ligne. Ici le dernier argument pass\u00e9 \u00e0 python est \n", " \n", "    for x in liste: x+1\n", "    \n", "   qui est interpr\u00e9t\u00e9 comme une seule ligne. Cette pratique doit absolument rester limit\u00e9e \u00e0 de tels usages sp\u00e9cifiques.\n"]}, {"block": 47, "type": "markdown", "linesLength": 1, "startIndex": 140, "lines": ["Cette forme est pratique notamment parce que `timeit` fait, comme on le voit, plusieurs essais successifs qui donnent un r\u00e9sultat plus repr\u00e9sentatif. C'est pourquoi vous la trouverez fr\u00e9quemment utilis\u00e9e dans les forums de discussion autour de python."]}]
[{"block": 0, "type": "markdown", "linesLength": 1, "startIndex": 0, "lines": ["<span style=\"float:left;\">Licence CC BY-NC-ND</span><span style=\"float:right;\">Thierry Parmentelat &amp; Arnaud Legout&nbsp;<img src=\"media/both-logos-small-alpha.png\" style=\"display:inline\"></span><br/>"]}, {"block": 1, "type": "markdown", "linesLength": 1, "startIndex": 1, "lines": ["# la librairie `asyncio`"]}, {"block": 2, "type": "markdown", "linesLength": 1, "startIndex": 2, "lines": ["* boucle d'\u00e9v\u00e9nements"]}, {"block": 3, "type": "markdown", "linesLength": 1, "startIndex": 3, "lines": ["* synchronisation: `Queue`, `Lock` et `Semaphore`"]}, {"block": 4, "type": "markdown", "linesLength": 2, "startIndex": 4, "lines": ["* interaction avec les processus:\n", "  * package `asyncio.subprocess`"]}, {"block": 5, "type": "markdown", "linesLength": 2, "startIndex": 6, "lines": ["* `Transport` et `Protocol` \n", "* `Streams`"]}, {"block": 6, "type": "code", "linesLength": 3, "startIndex": 8, "lines": ["import asyncio\n", "\n", "from asynchelpers import start_timer, show_timer"]}, {"block": 7, "type": "markdown", "linesLength": 1, "startIndex": 11, "lines": ["# synchronisation avec une queue"]}, {"block": 8, "type": "code", "linesLength": 1, "startIndex": 12, "lines": ["asyncio.Queue?"]}, {"block": 9, "type": "code", "linesLength": 1, "startIndex": 13, "lines": ["queue = asyncio.Queue(maxsize=1)"]}, {"block": 10, "type": "code", "linesLength": 6, "startIndex": 14, "lines": ["async def producer(queue):\n", "    count = 1\n", "    while True:\n", "        await queue.put(f'tick{count}')\n", "        count += 1\n", "        await asyncio.sleep(1)"]}, {"block": 11, "type": "code", "linesLength": 5, "startIndex": 20, "lines": ["async def consumer(queue):\n", "    while True:\n", "        received = await queue.get()\n", "        show_timer(f\"got {received}\")\n", "        "]}, {"block": 12, "type": "code", "linesLength": 3, "startIndex": 25, "lines": ["# on ajoute les coroutines dans la boucle\n", "asyncio.ensure_future(producer(queue))\n", "asyncio.ensure_future(consumer(queue))"]}, {"block": 13, "type": "code", "linesLength": 9, "startIndex": 28, "lines": ["start_timer()\n", "\n", "# interrompre avec la touche 'i' \n", "# plusieurs fois si n\u00e9cessaire\n", "\n", "try:\n", "    asyncio.get_event_loop().run_forever()\n", "except KeyboardInterrupt as e:\n", "    print(\"bye\")"]}, {"block": 14, "type": "markdown", "linesLength": 1, "startIndex": 37, "lines": ["# limiter le parall\u00e8lisme avec `Queue`"]}, {"block": 15, "type": "code", "linesLength": 1, "startIndex": 38, "lines": ["asyncio.set_event_loop(asyncio.new_event_loop())"]}, {"block": 16, "type": "code", "linesLength": 1, "startIndex": 39, "lines": ["window = asyncio.Queue(maxsize = 4)"]}, {"block": 17, "type": "code", "linesLength": 11, "startIndex": 40, "lines": ["async def job(i):\n", "    # prendre un jeton dans la queue\n", "    await window.put(None)\n", "    # pas tout le monde la m\u00eame dur\u00e9e\n", "    duration = (i % 3) + 1\n", "    message = f\"job{i} - duration {duration}\"\n", "    show_timer(\">>>\", message)\n", "    await asyncio.sleep(duration)\n", "    show_timer(\"<<<\", message)\n", "    # lib\u00e9rer le jeton\n", "    await window.get()"]}, {"block": 18, "type": "code", "linesLength": 8, "startIndex": 51, "lines": ["for i in range(8):\n", "    asyncio.ensure_future(job(i))\n", "\n", "start_timer()\n", "try:\n", "    asyncio.get_event_loop().run_forever()\n", "except:\n", "    print('bye')"]}, {"block": 19, "type": "markdown", "linesLength": 9, "startIndex": 59, "lines": ["### S\u00e9quencement des jobs\n", "\n", "|     | j0 (1) | j1(2) | j2(3) | j3(1) | j4(2) | j5(3) | j6(1) | j7(2) |\n", "|-----|--------|-------|-------|-------|-------|-------|-------|-------|\n", "| 0-1 | `*`    | `*`   | `*`   | `*`   |       |       |       |       |\n", "| 1-2 |        | `*`   | `*`   |       | `*`   | `*`   |       |       |\n", "| 2-3 |        |       | `*`   |       | `*`   | `*`   | `*`   |       |\n", "| 3-4 |        |       |       |       |       | `*`   |       | `*`   |\n", "| 4-5 |        |       |       |       |       |       |       | `*`   |"]}, {"block": 20, "type": "markdown", "linesLength": 1, "startIndex": 68, "lines": ["# valeur ajout\u00e9e"]}, {"block": 21, "type": "markdown", "linesLength": 6, "startIndex": 69, "lines": ["* boucle d'\u00e9v\u00e9nements complice avec:\n", "  * `sleep()`,\n", "  * `subprocess.*`\n", "  * les classes abstraites:\n", "  \n", "    `Transport`, `Protocol`, `Stream`"]}, {"block": 22, "type": "markdown", "linesLength": 4, "startIndex": 75, "lines": ["* tire profit de l'OS\n", "  * *signal()* : interruptions\n", "  * *select()* : \u00e9v\u00e9nements li\u00e9s aux entr\u00e9e-sorties\n", "  * ..."]}, {"block": 23, "type": "markdown", "linesLength": 1, "startIndex": 79, "lines": ["# usage"]}, {"block": 24, "type": "markdown", "linesLength": 5, "startIndex": 80, "lines": ["* commencer avec les librairies de haut niveau\n", "  * HTTP (`aoihttp`) \n", "  * ssh (`asyncssh`)\n", "  * telnet (`telnetlib3`) \n", "  * BdD's - ..."]}]
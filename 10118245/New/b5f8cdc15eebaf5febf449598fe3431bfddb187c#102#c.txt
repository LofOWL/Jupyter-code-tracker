[{"block": 0, "type": "markdown", "linesLength": 1, "startIndex": 0, "lines": ["<span style=\"float:left;\">Licence CC BY-NC-ND</span><span style=\"float:right;\">Thierry Parmentelat &amp; Arnaud Legout&nbsp;<img src=\"media/both-logos-small-alpha.png\" style=\"display:inline\"></span><br/>"]}, {"block": 1, "type": "markdown", "linesLength": 1, "startIndex": 1, "lines": ["# H\u00e9ritage multiple"]}, {"block": 2, "type": "markdown", "linesLength": 1, "startIndex": 2, "lines": ["## Compl\u00e9ment - niveau interm\u00e9diaire"]}, {"block": 3, "type": "markdown", "linesLength": 1, "startIndex": 3, "lines": ["### La classe `object`"]}, {"block": 4, "type": "markdown", "linesLength": 1, "startIndex": 4, "lines": ["Le symbole `object` est une variable pr\u00e9d\u00e9finie (qui donc fait partie du module `builtins`):"]}, {"block": 5, "type": "code", "linesLength": 1, "startIndex": 5, "lines": ["object"]}, {"block": 6, "type": "code", "linesLength": 3, "startIndex": 6, "lines": ["import builtins\n", "\n", "builtins.object is object"]}, {"block": 7, "type": "markdown", "linesLength": 1, "startIndex": 9, "lines": ["La classe `object` une classe sp\u00e9ciale; toutes les classes en python h\u00e9ritent de la classe `object`, m\u00eame lorsqu'aucun h\u00e9ritage n'est sp\u00e9cifi\u00e9:"]}, {"block": 8, "type": "code", "linesLength": 4, "startIndex": 10, "lines": ["class Foo:\n", "    pass\n", "\n", "Foo.__bases__"]}, {"block": 9, "type": "markdown", "linesLength": 1, "startIndex": 14, "lines": ["L'attribut sp\u00e9cial `__bases__`, comme on le devine, nous permet d'acc\u00e9der aux superclasses directes, ici de la classe `Foo`."]}, {"block": 10, "type": "markdown", "linesLength": 1, "startIndex": 15, "lines": ["En python moderne, on n'a **jamais besoin de mentionner** `object` dans le code. La raison de sa pr\u00e9sence dans les symboles pr\u00e9d\u00e9finis est li\u00e9e \u00e0 l'histoire de python, et \u00e0 la distinction que faisait python2 entre classes *old-style* et classes *new-style*. Nous le mentionnons seulement car on rencontre encore parfois du code qui fait quelque chose comme:"]}, {"block": 11, "type": "code", "linesLength": 2, "startIndex": 16, "lines": ["class Bar(object):\n", "    pass"]}, {"block": 12, "type": "markdown", "linesLength": 1, "startIndex": 18, "lines": ["qui est un reste de python2, et que python3 accepte uniquement au titre de la compatibilit\u00e9."]}, {"block": 13, "type": "markdown", "linesLength": 1, "startIndex": 19, "lines": ["****"]}, {"block": 14, "type": "markdown", "linesLength": 1, "startIndex": 20, "lines": ["## Compl\u00e9ment - niveau avanc\u00e9"]}, {"block": 15, "type": "markdown", "linesLength": 1, "startIndex": 21, "lines": ["### Rappels"]}, {"block": 16, "type": "markdown", "linesLength": 4, "startIndex": 22, "lines": ["L'h\u00e9ritage en python consiste principalement en l'algorithme de recherche d'un attribut d'une instance; celui-ci regarde :\n", "1. d'abord dans l'instance,\n", "1. ensuite dans la classe,\n", "1. ensuite dans les super-classes."]}, {"block": 17, "type": "markdown", "linesLength": 1, "startIndex": 26, "lines": ["### Le probl\u00e8me"]}, {"block": 18, "type": "markdown", "linesLength": 3, "startIndex": 27, "lines": ["Les deux premiers points ne posent pas de probl\u00e8me de d\u00e9finition, puisque l'objet lui-m\u00eame et sa classe sont **d\u00e9finis de mani\u00e8re unique**. \n", "\n", "Par contre, lorsqu'on utilise l'h\u00e9ritage multiple, on peut imaginer trouver l'attribut recherch\u00e9 dans **plusieurs superclasses**. Il est donc important de pr\u00e9ciser, dans le cas o\u00f9 plusieurs superclasses poss\u00e8dent l'attribut recherch\u00e9, quel est celui qui doit \u00eatre retenu. "]}, {"block": 19, "type": "markdown", "linesLength": 1, "startIndex": 30, "lines": ["### Ordre sur les superclasses"]}, {"block": 20, "type": "markdown", "linesLength": 9, "startIndex": 31, "lines": ["Le probl\u00e8me revient donc \u00e0 d\u00e9finir un **ordre** sur l'ensemble des **super-classes**. On parle bien, naturellement, de **toutes** les super-classes, pas seulement celles dont on h\u00e9rite directement - en termes savants on dirait qu'on s'int\u00e9resse \u00e0 la fermeture transitive de la relation d'h\u00e9ritage.\n", "\n", "Apr\u00e8s quelques errements (d\u00e9crits dans la premi\u00e8re r\u00e9f\u00e9rence de la derni\u00e8re section, \"Pour en savoir plus\"), L'algorithme qui a \u00e9t\u00e9 choisi - apr\u00e8s quelques t\u00e2tonnements - pour d\u00e9terminer l'ordre des superclasses est en service depuis la version 2.3, et est connu sous le nom de **lin\u00e9arisation C3**. Cet algorithme n'est pas propre \u00e0 python, comme vous pourrez le lire dans les r\u00e9f\u00e9rences cit\u00e9es dans la derni\u00e8re section.\n", "\n", "Nous ne d\u00e9crirons pas ici l'algorithme lui-m\u00eame dans le d\u00e9tail; par contre nous allons:\n", " * dans un premier temps r\u00e9sumer **les raisons** qui ont guid\u00e9 ce choix, en d\u00e9crivant les bonnes propri\u00e9t\u00e9s que l'on attend, ainsi que les **limitations** qui en d\u00e9coulent;\n", " * puis voir l'ordre obtenu sur quelques **exemples** concrets de hi\u00e9rarchies de classes.\n", " \n", "Vous trouverez dans les r\u00e9f\u00e9rences (voir ci-dessous la derni\u00e8re section, \"Pour en savoir plus\") des liens vers des documents plus techniques si vous souhaitez creuser le sujet."]}, {"block": 21, "type": "markdown", "linesLength": 1, "startIndex": 40, "lines": ["### Les bonnes propri\u00e9t\u00e9s attendues"]}, {"block": 22, "type": "markdown", "linesLength": 1, "startIndex": 41, "lines": ["Il y a un certain nombre de bonnes propri\u00e9t\u00e9s que l'on attend de cet algorithme."]}, {"block": 23, "type": "markdown", "linesLength": 1, "startIndex": 42, "lines": ["##### Priorit\u00e9 au sp\u00e9cifique"]}, {"block": 24, "type": "markdown", "linesLength": 1, "startIndex": 43, "lines": ["Lorsqu'une classe A h\u00e9rite d'une classe B, on s'attend \u00e0 ce que les m\u00e9thodes d\u00e9finies sur A, qui sont en principe plus sp\u00e9cifiques, soient utilis\u00e9es de pr\u00e9f\u00e9rence \u00e0 celles d\u00e9finies sur B."]}, {"block": 25, "type": "markdown", "linesLength": 1, "startIndex": 44, "lines": ["##### Priorit\u00e9 \u00e0 gauche"]}, {"block": 26, "type": "markdown", "linesLength": 1, "startIndex": 45, "lines": ["Lorsqu'on utilise l'h\u00e9ritage multiple, on mentionne les classes m\u00e8res dans un certain ordre, qui n'est pas anodin. Les classes mentionn\u00e9es en premier sont bien entendu celles desquelles on veut h\u00e9riter en priorit\u00e9."]}, {"block": 27, "type": "markdown", "linesLength": 1, "startIndex": 46, "lines": ["##### De mani\u00e8re un peu plus formelle"]}, {"block": 28, "type": "markdown", "linesLength": 4, "startIndex": 47, "lines": ["Pour reformuler les deux points ci-dessus d'une mani\u00e8re un peu plus formelle&nbsp;:\n", " * on se donne un objet *o* de la classe *O*\n", " * on consid\u00e8re l'ensemble $\\cal{S}$ des superclasses de *O* (qui contient *O*), \n", " * et on cherche \u00e0 construire la MRO (Method Resolution Order), c'est-\u00e0-dire la liste $\\cal{MRO}$ ordonn\u00e9e des \u00e9l\u00e9ments de $\\cal{S}$ dans lesquelles chercher les attributs de *o*."]}, {"block": 29, "type": "markdown", "linesLength": 6, "startIndex": 51, "lines": ["Les deux r\u00e8gles ci-dessus s'\u00e9crivent alors comme ceci&nbsp;:\n", "\n", " * $\\forall A,B \\in \\cal{S}$,  A h\u00e9rite de B $\\Rightarrow$ A est avant B dans $\\cal{MRO}$\n", " * $\\forall B,C,D \\in \\cal{S}$, B h\u00e9rite de C puis de D $\\Rightarrow$ B est avant C qui est avant D dans $\\cal{MRO}$\n", " \n", "La formule \"B h\u00e9rite de C puis de D\" est \u00e0 prendre ici au sens large; B peut h\u00e9riter de plus de deux classes, tout ce qui est demand\u00e9 est que C  apparaisse avant D dans la liste des classes m\u00e8res.\n"]}, {"block": 30, "type": "markdown", "linesLength": 1, "startIndex": 57, "lines": ["##### Limitations : toutes les hi\u00e9rarchies ne peuvent pas \u00eatre trait\u00e9es"]}, {"block": 31, "type": "markdown", "linesLength": 1, "startIndex": 58, "lines": ["L'algorithme C3 permet de calculer un ordre sur $\\cal{S}$ qui respecte toutes ces contraintes, lorsqu'il en existe un. En effet, dans certains cas on ne peut pas trouver un tel ordre. Nous en verrons un exemple vers la fin de ce document&nbsp;; comme vous le verrez on peut exhiber de tels exemples qui restent relativement simples. Cependant, dans la pratique, il est assez rare de tomber sur de tels cas pathologiques; et lorsque cela se produit c'est en g\u00e9n\u00e9ral le signe d'erreurs de conception plus profondes."]}, {"block": 32, "type": "markdown", "linesLength": 1, "startIndex": 59, "lines": ["### Un exemple tr\u00e8s simple"]}, {"block": 33, "type": "markdown", "linesLength": 1, "startIndex": 60, "lines": ["On se donne la hi\u00e9rarchie suivante."]}, {"block": 34, "type": "code", "linesLength": 21, "startIndex": 61, "lines": ["class LeftTop(object):\n", "    def attribut(self): \n", "        return \"attribut(LeftTop)\"\n", "    \n", "class LeftMiddle(LeftTop): \n", "    pass\n", "\n", "class Left(LeftMiddle): \n", "    pass\n", "\n", "class Middle(object): \n", "    pass\n", "\n", "class Right(object):\n", "    def attribut(self): \n", "        return \"attribut(Right)\"\n", "\n", "class Class(Left, Middle, Right): \n", "    pass\n", "\n", "instance = Class()"]}, {"block": 35, "type": "markdown", "linesLength": 3, "startIndex": 82, "lines": ["qui donne en version dessin\u00e9e, avec deux points rouges pour repr\u00e9senter les deux d\u00e9finitions de la m\u00e9thode `attribut`:\n", "\n", "<img src=\"media/heritage-multiple01.png\" height=\"40\">"]}, {"block": 36, "type": "markdown", "linesLength": 1, "startIndex": 85, "lines": ["Les deux r\u00e8gles, telles que nous les avons \u00e9nonc\u00e9es en premier lieu (priorit\u00e9 \u00e0 gauche, priorit\u00e9 au sp\u00e9cifique) sont un peu contradictoires ici. En fait, c'est la m\u00e9thode de `LeftTop` qui est h\u00e9rit\u00e9e dans `Class`, comme on le voit ici&nbsp;:"]}, {"block": 37, "type": "code", "linesLength": 1, "startIndex": 86, "lines": ["instance.attribut() == 'attribut(LeftTop)'"]}, {"block": 38, "type": "markdown", "linesLength": 1, "startIndex": 87, "lines": ["**Exercice**: Remarquez qu'ici `Right` a elle-m\u00eame un h\u00e9ritage tr\u00e8s simple. \u00c0 titre d'exercice, modifiez le code ci-dessus pour faire que `Right` h\u00e9rite de la classe `LeftMiddle`; de quelle classe d'apr\u00e8s vous est-ce que `Class` h\u00e9rite `attribut` dans cette configuration ?"]}, {"block": 39, "type": "markdown", "linesLength": 1, "startIndex": 88, "lines": ["##### Si cela ne vous convient pas"]}, {"block": 40, "type": "markdown", "linesLength": 1, "startIndex": 89, "lines": ["C'est une \u00e9vidence, mais cela va peut-\u00eatre mieux en le rappelant&nbsp;: si la m\u00e9thode que vous obtenez \"gratuitement\" avec l'h\u00e9ritage n'est pas celle qui vous convient, vous avez naturellement toujours la possibilit\u00e9 de la red\u00e9finir, et ainsi d'en **choisir** une autre. Ainsi dans notre exemple si on pr\u00e9f\u00e8re la m\u00e9thode impl\u00e9ment\u00e9e dans `Right`, on d\u00e9finira plut\u00f4t la classe `Class` comme ceci&nbsp;:"]}, {"block": 41, "type": "code", "linesLength": 6, "startIndex": 90, "lines": ["class Class(Left, Middle, Right):\n", "    def attribut(*args, **kwds):\n", "        return Right.attribut(*args, **kwds)\n", "    \n", "instance2 = Class()\n", "instance2.attribut()"]}, {"block": 42, "type": "markdown", "linesLength": 1, "startIndex": 96, "lines": ["Ou encore bien entendu, si dans votre contexte vous devez appelez **les deux** m\u00e9thodes dont vous pourriez h\u00e9riter et les combiner, vous pouvez le faire aussi, par exemple comme ceci&nbsp;:"]}, {"block": 43, "type": "code", "linesLength": 6, "startIndex": 97, "lines": ["class Class(Left, Middle, Right):\n", "    def attribut(*args, **kwds):\n", "        return LeftTop.attribut(*args, **kwds) + \" ** \" + Right.attribut(*args, **kwds) \n", "    \n", "instance3 = Class()\n", "instance3.attribut()"]}, {"block": 44, "type": "markdown", "linesLength": 1, "startIndex": 103, "lines": ["### Un exemple un peu plus compliqu\u00e9"]}, {"block": 45, "type": "markdown", "linesLength": 1, "startIndex": 104, "lines": ["Voici un exemple tir\u00e9 de la deuxi\u00e8me r\u00e9f\u00e9rence (voir ci-dessous la derni\u00e8re section, \"Pour en savoir plus\")."]}, {"block": 46, "type": "code", "linesLength": 7, "startIndex": 105, "lines": ["O = object\n", "class F(O): pass\n", "class E(O): pass\n", "class D(O): pass\n", "class C(D, F): pass\n", "class B(E, D): pass\n", "class A(B, C): pass"]}, {"block": 47, "type": "markdown", "linesLength": 1, "startIndex": 112, "lines": ["Cette hi\u00e9rarchie nous donne, en partant de A, l'ordre suivant"]}, {"block": 48, "type": "markdown", "linesLength": 22, "startIndex": 113, "lines": ["                               6\n", "                              ---\n", "    Level 3                  | O |\n", "                           /  ---  \\\n", "                          /    |    \\\n", "                         /     |     \\\n", "                        /      |      \\\n", "                      ---     ---    ---\n", "    Level 2        2 | E | 4 | D |  | F | 5\n", "                      ---     ---    ---\n", "                       \\      / \\     /\n", "                        \\    /   \\   /\n", "                         \\  /     \\ /\n", "                          ---     ---\n", "    Level 1            1 | B |   | C | 3\n", "                          ---     ---\n", "                           \\       /\n", "                            \\     /\n", "                              ---\n", "    Level 0                0 | A |\n", "                              ---\n", "    "]}, {"block": 49, "type": "markdown", "linesLength": 1, "startIndex": 135, "lines": ["Que l'on peut calculer, sous l'interpr\u00e9teur python, avec la m\u00e9thode `mro` sur la classe de d\u00e9part&nbsp;:"]}, {"block": 50, "type": "code", "linesLength": 1, "startIndex": 136, "lines": ["A.mro()"]}, {"block": 51, "type": "markdown", "linesLength": 1, "startIndex": 137, "lines": ["### Un exemple qui ne peut pas \u00eatre trait\u00e9"]}, {"block": 52, "type": "markdown", "linesLength": 3, "startIndex": 138, "lines": ["Voici enfin un exemple de hi\u00e9rarchie pour laquelle on ne **peut pas trouver d'ordre** qui respecte les bonnes propri\u00e9t\u00e9s que l'on a vues tout \u00e0 l'heure, et qui pour cette raison sera **rejet\u00e9e par l'interpr\u00e9teur python**. D'abord en version dessin\u00e9e\n", "\n", "<img src=\"media/heritage-multiple02.png\">"]}, {"block": 53, "type": "code", "linesLength": 13, "startIndex": 141, "lines": ["# en version code\n", "class X: pass\n", "class Y: pass\n", "class XY(X, Y): pass\n", "class YX(Y, X): pass\n", "\n", "# on essaie de cr\u00e9er une sous-classe de XY et YX\n", "try:\n", "    class Class(XY,YX): pass \n", "# mais ce n'est pas possible\n", "except Exception as e:\n", "    print(\"On ne peut pas cr\u00e9er Class\")\n", "    print(e)"]}, {"block": 54, "type": "markdown", "linesLength": 1, "startIndex": 154, "lines": ["### Pour en savoir plus"]}, {"block": 55, "type": "markdown", "linesLength": 4, "startIndex": 155, "lines": [" 1. Un [blog de Guido Van Rossum](http://python-history.blogspot.fr/2010/06/method-resolution-order.html\n", ") qui retrace l'historique des diff\u00e9rents essais qui ont \u00e9t\u00e9 faits avant de converger sur le mod\u00e8le actuel.\n", " 1. Un [article technique](https://www.python.org/download/releases/2.3/mro/) qui d\u00e9crit le fonctionnement de l'algorithme de calcul de la MRO, et donne des exemples.\n", " 1. L'[article de wikipedia](http://en.wikipedia.org/wiki/C3_linearization) sur l'algorithme C3."]}]
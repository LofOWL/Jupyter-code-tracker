[{"block": 0, "type": "code", "linesLength": 3, "startIndex": 0, "lines": ["%matplotlib inline\n", "%reload_ext autoreload\n", "%autoreload 2"]}, {"block": 1, "type": "markdown", "linesLength": 1, "startIndex": 3, "lines": ["## Super resolution data"]}, {"block": 2, "type": "code", "linesLength": 5, "startIndex": 4, "lines": ["from fastai.conv_learner import *\n", "from pathlib import Path\n", "torch.cuda.set_device(0)\n", "\n", "torch.backends.cudnn.benchmark=True"]}, {"block": 3, "type": "code", "linesLength": 2, "startIndex": 9, "lines": ["PATH = Path('data/imagenet')\n", "PATH_TRN = PATH/'train'"]}, {"block": 4, "type": "code", "linesLength": 3, "startIndex": 11, "lines": ["fnames_full,label_arr_full,all_labels = folder_source(PATH, 'train')\n", "fnames_full = ['/'.join(Path(fn).parts[-2:]) for fn in fnames_full]\n", "list(zip(fnames_full[:5],label_arr_full[:5]))"]}, {"block": 5, "type": "code", "linesLength": 1, "startIndex": 14, "lines": ["all_labels[:5]"]}, {"block": 6, "type": "code", "linesLength": 5, "startIndex": 15, "lines": ["np.random.seed(42)\n", "keep_pct = 1.\n", "keeps = np.random.rand(len(fnames_full)) < keep_pct\n", "fnames = np.array(fnames_full, copy=False)[keeps]\n", "label_arr = np.array(label_arr_full, copy=False)[keeps]"]}, {"block": 7, "type": "code", "linesLength": 3, "startIndex": 20, "lines": ["arch = vgg16\n", "sz_hr,sz_lr = 288,72\n", "bs = 24"]}, {"block": 8, "type": "code", "linesLength": 7, "startIndex": 23, "lines": ["class MatchedFilesDataset(FilesDataset):\n", "    def __init__(self, fnames, y, transform, path):\n", "        self.y=y\n", "        assert(len(fnames)==len(y))\n", "        super().__init__(fnames, transform, path)\n", "    def get_y(self, i): return open_image(os.path.join(self.path, self.y[i]))\n", "    def get_c(self): return 0"]}, {"block": 9, "type": "code", "linesLength": 2, "startIndex": 30, "lines": ["aug_tfms = [RandomFlip(tfm_y=TfmType.PIXEL),\n", "            RandomLighting(0.1, 0.2, tfm_y=TfmType.PIXEL)]"]}, {"block": 10, "type": "code", "linesLength": 3, "startIndex": 32, "lines": ["val_idxs = get_cv_idxs(len(fnames), val_pct=min(0.01/keep_pct, 0.1))\n", "((val_x,trn_x),(val_y,trn_y)) = split_by_idx(val_idxs, np.array(fnames), np.array(fnames))\n", "len(val_x),len(trn_x)"]}, {"block": 11, "type": "code", "linesLength": 3, "startIndex": 35, "lines": ["tfms = tfms_from_model(arch, sz_lr, tfm_y=TfmType.PIXEL, aug_tfms=aug_tfms, sz_y=sz_hr, norm_y=False)\n", "datasets = ImageData.get_ds(MatchedFilesDataset, (trn_x,trn_y), (val_x,val_y), tfms, path=PATH_TRN)\n", "md = ImageData(PATH, datasets, bs, num_workers=16, classes=None)"]}, {"block": 12, "type": "code", "linesLength": 1, "startIndex": 38, "lines": ["denorm = md.trn_ds.denorm"]}, {"block": 13, "type": "code", "linesLength": 6, "startIndex": 39, "lines": ["def show_img(ims, idx, figsize=(5,5), normed=True, ax=None):\n", "    if ax is None: fig,ax = plt.subplots(figsize=figsize)\n", "    if normed: ims = denorm(ims)\n", "    else:      ims = np.rollaxis(to_np(ims),1,4)\n", "    ax.imshow(np.clip(ims,0,1)[idx], interpolation=\"bilinear\")\n", "    ax.axis('off')"]}, {"block": 14, "type": "code", "linesLength": 2, "startIndex": 45, "lines": ["x,y = next(iter(md.val_dl))\n", "x.size(),y.size()"]}, {"block": 15, "type": "code", "linesLength": 4, "startIndex": 47, "lines": ["idx=15\n", "fig,axes = plt.subplots(1, 2, figsize=(9,5))\n", "show_img(x,idx, ax=axes[0])\n", "show_img(y,idx, ax=axes[1], normed=False)"]}, {"block": 16, "type": "code", "linesLength": 1, "startIndex": 51, "lines": ["batches = [next(iter(md.aug_dl)) for i in range(9)]"]}, {"block": 17, "type": "code", "linesLength": 4, "startIndex": 52, "lines": ["fig, axes = plt.subplots(3, 6, figsize=(18, 9))\n", "for i,(x,y) in enumerate(batches):\n", "    show_img(x,idx, ax=axes.flat[i*2])\n", "    show_img(y,idx, ax=axes.flat[i*2+1], normed=False)"]}, {"block": 18, "type": "markdown", "linesLength": 1, "startIndex": 56, "lines": ["## Model"]}, {"block": 19, "type": "code", "linesLength": 9, "startIndex": 57, "lines": ["def conv_bn_relu(ni, nf, kernel_size=3, bias=False, actn=True):\n", "    pad = kernel_size//2\n", "    layers = [\n", "        nn.ReflectionPad2d(pad),\n", "        nn.Conv2d(ni, nf, kernel_size, padding=0, bias=bias),\n", "        nn.BatchNorm2d(nf)\n", "    ]\n", "    if actn: layers.append(nn.ReLU(inplace=True))\n", "    return nn.Sequential(*layers)"]}, {"block": 20, "type": "code", "linesLength": 6, "startIndex": 66, "lines": ["class ResSequential(nn.Module):\n", "    def __init__(self, *layers):\n", "        super().__init__()\n", "        self.m = nn.Sequential(*layers)\n", "\n", "    def forward(self, x): return x + self.m(x)"]}, {"block": 21, "type": "code", "linesLength": 4, "startIndex": 72, "lines": ["def res_block(nf):\n", "    return ResSequential(\n", "        conv_bn_relu(nf, nf),\n", "        conv_bn_relu(nf, nf, actn=False))"]}, {"block": 22, "type": "code", "linesLength": 4, "startIndex": 76, "lines": ["def upsample():\n", "    return nn.Sequential(\n", "        nn.Upsample(scale_factor=2),\n", "        conv_bn_relu(64, 64))"]}, {"block": 23, "type": "code", "linesLength": 12, "startIndex": 80, "lines": ["class SrResnet(nn.Module):\n", "    def __init__(self):\n", "        super().__init__()\n", "        features = [conv_bn_relu(3, 64, 9)]\n", "        for i in range(4): features.append(res_block(64))\n", "        features += [\n", "            upsample(), upsample(),\n", "            nn.ReflectionPad2d(4),\n", "            nn.Conv2d(64, 3, kernel_size=9, bias=True, padding=0)]\n", "        self.features = nn.Sequential(*features)\n", "        \n", "    def forward(self, x): return F.sigmoid(self.features(x))"]}, {"block": 24, "type": "markdown", "linesLength": 1, "startIndex": 92, "lines": ["## Pixel loss"]}, {"block": 25, "type": "code", "linesLength": 1, "startIndex": 93, "lines": ["m = to_gpu(SrResnet())"]}, {"block": 26, "type": "code", "linesLength": 1, "startIndex": 94, "lines": ["m = nn.DataParallel(m, [0,2])"]}, {"block": 27, "type": "code", "linesLength": 2, "startIndex": 95, "lines": ["learn = Learner(md, SingleModel(m), opt_fn=opt_fn)\n", "learn.crit = F.mse_loss"]}, {"block": 28, "type": "code", "linesLength": 2, "startIndex": 97, "lines": ["learn.lr_find(start_lr=1e-4, end_lr=10000)\n", "learn.sched.plot()"]}, {"block": 29, "type": "code", "linesLength": 1, "startIndex": 99, "lines": ["lr=1e-3"]}, {"block": 30, "type": "code", "linesLength": 1, "startIndex": 100, "lines": ["learn.fit(lr, 1, cycle_len=1, use_clr_beta=(40,10))"]}, {"block": 31, "type": "code", "linesLength": 2, "startIndex": 101, "lines": ["x,y = next(iter(md.val_dl))\n", "preds = learn.model(VV(x))"]}, {"block": 32, "type": "code", "linesLength": 1, "startIndex": 103, "lines": ["show_img(y,idx,normed=False)"]}, {"block": 33, "type": "code", "linesLength": 1, "startIndex": 104, "lines": ["show_img(preds,idx,normed=False);"]}, {"block": 34, "type": "code", "linesLength": 1, "startIndex": 105, "lines": ["show_img(x,idx);"]}, {"block": 35, "type": "markdown", "linesLength": 1, "startIndex": 106, "lines": ["## Perceptual loss"]}, {"block": 36, "type": "code", "linesLength": 1, "startIndex": 107, "lines": ["m_vgg = vgg16(True)"]}, {"block": 37, "type": "code", "linesLength": 3, "startIndex": 108, "lines": ["blocks = [i-1 for i,o in enumerate(children(m_vgg))\n", "              if isinstance(o,nn.MaxPool2d)]\n", "blocks"]}, {"block": 38, "type": "code", "linesLength": 1, "startIndex": 111, "lines": ["[m_vgg[i] for i in blocks]"]}, {"block": 39, "type": "code", "linesLength": 2, "startIndex": 112, "lines": ["m_vgg = nn.Sequential(*children(m_vgg)[:23]).cuda().eval()\n", "set_trainable(m_vgg, False)"]}, {"block": 40, "type": "code", "linesLength": 1, "startIndex": 114, "lines": ["def flatten(x): return x.view(x.size(0), -1)"]}, {"block": 41, "type": "code", "linesLength": 5, "startIndex": 115, "lines": ["class SaveFeatures():\n", "    features=None\n", "    def __init__(self, m): self.hook = m.register_forward_hook(self.hook_fn)\n", "    def hook_fn(self, module, input, output): self.features = output\n", "    def remove(self): self.hook.remove()        "]}, {"block": 42, "type": "code", "linesLength": 17, "startIndex": 120, "lines": ["class FeatureLoss(nn.Module):\n", "    def __init__(self, m, layer_ids, layer_wgts):\n", "        super().__init__()\n", "        self.m,self.wgts = m,layer_wgts\n", "        self.sfs = [SaveFeatures(m[i]) for i in layer_ids]\n", "\n", "    def forward(self, input, target, sum_layers=True):\n", "        self.m(VV(target.data))\n", "        targ_feat = [V(o.features.data.clone()) for o in self.sfs]\n", "        self.m(input)\n", "        res = [F.mse_loss(flatten(inp.features),flatten(targ))*wgt\n", "               for inp,targ,wgt in zip(self.sfs, targ_feat, self.wgts)]\n", "        if sum_layers: res = sum(res)\n", "        return res\n", "    \n", "    def close(self):\n", "        for o in self.sfs: o.remove()"]}, {"block": 43, "type": "code", "linesLength": 4, "startIndex": 137, "lines": ["m = to_gpu(SrResnet())\n", "m = nn.DataParallel(m, [0,2])\n", "\n", "learn = Learner(md, SingleModel(m), opt_fn=optim.Adam)"]}, {"block": 44, "type": "code", "linesLength": 1, "startIndex": 141, "lines": ["learn.crit = FeatureLoss(m_vgg, blocks[:3], [0.2,0.7,0.1])"]}, {"block": 45, "type": "code", "linesLength": 2, "startIndex": 142, "lines": ["learn.lr_find(1e-4, 1000)\n", "learn.sched.plot()"]}, {"block": 46, "type": "code", "linesLength": 2, "startIndex": 144, "lines": ["lr=2e-3\n", "wd=1e-7"]}, {"block": 47, "type": "code", "linesLength": 1, "startIndex": 146, "lines": ["learn.load('sr-samp0')"]}, {"block": 48, "type": "code", "linesLength": 1, "startIndex": 147, "lines": ["learn.fit(lr, 1, cycle_len=1, wds=wd, use_clr=(20,40,0.95,0.85))"]}, {"block": 49, "type": "code", "linesLength": 1, "startIndex": 148, "lines": ["learn.save('sr-samp0')"]}, {"block": 50, "type": "code", "linesLength": 1, "startIndex": 149, "lines": ["learn.sched.plot_loss()"]}, {"block": 51, "type": "code", "linesLength": 1, "startIndex": 150, "lines": ["learn.fit(lr/10, 1, cycle_len=1, wds=wd, use_clr=(20,40,0.95,0.85))"]}, {"block": 52, "type": "code", "linesLength": 1, "startIndex": 151, "lines": ["learn.save('sr')"]}, {"block": 53, "type": "code", "linesLength": 1, "startIndex": 152, "lines": ["learn.load('sr')"]}, {"block": 54, "type": "code", "linesLength": 7, "startIndex": 153, "lines": ["def plot_ds_img(idx, ax=None, figsize=(7,7), normed=True):\n", "    if ax is None: fig,ax = plt.subplots(figsize=figsize)\n", "    im = md.val_ds[idx][0]\n", "    if normed: im = denorm(im)[0]\n", "    else:      im = np.rollaxis(to_np(im),0,3)\n", "    ax.imshow(im, interpolation=\"bilinear\")\n", "    ax.axis('off')"]}, {"block": 55, "type": "code", "linesLength": 2, "startIndex": 160, "lines": ["fig,axes=plt.subplots(8,4,figsize=(12,24))\n", "for i,ax in enumerate(axes.flat): plot_ds_img(i+156,ax=ax, normed=True)"]}, {"block": 56, "type": "code", "linesLength": 1, "startIndex": 162, "lines": ["x,y=md.val_ds[183]"]}, {"block": 57, "type": "code", "linesLength": 1, "startIndex": 163, "lines": ["y=y[None]"]}, {"block": 58, "type": "code", "linesLength": 2, "startIndex": 164, "lines": ["learn.model.eval()\n", "preds = learn.model(VV(x[None]))"]}, {"block": 59, "type": "code", "linesLength": 1, "startIndex": 166, "lines": ["learn.crit(preds, V(y), sum_layers=False)"]}, {"block": 60, "type": "code", "linesLength": 1, "startIndex": 167, "lines": ["learn.crit.close()"]}, {"block": 61, "type": "code", "linesLength": 1, "startIndex": 168, "lines": ["show_img(preds,0, normed=False)"]}, {"block": 62, "type": "code", "linesLength": 1, "startIndex": 169, "lines": ["show_img(x[None],0)"]}, {"block": 63, "type": "code", "linesLength": 0, "startIndex": 170, "lines": []}, {"block": 64, "type": "code", "linesLength": 4, "startIndex": 170, "lines": ["def nrm_y(y):\n", "    y = np.rollaxis(y,1,4)\n", "    y,_ = tfms[1].norm(y)\n", "    return np.rollaxis(y,3,1)"]}, {"block": 65, "type": "code", "linesLength": 1, "startIndex": 174, "lines": ["preds = learn.model(VV(nrm_y(y)))"]}, {"block": 66, "type": "code", "linesLength": 1, "startIndex": 175, "lines": ["show_img(y,0, figsize=(14,14), normed=False)"]}, {"block": 67, "type": "code", "linesLength": 1, "startIndex": 176, "lines": ["show_img(preds,0, figsize=(16,16), normed=False)"]}, {"block": 68, "type": "code", "linesLength": 1, "startIndex": 177, "lines": ["learn.save('sr')"]}, {"block": 69, "type": "code", "linesLength": 0, "startIndex": 178, "lines": []}]
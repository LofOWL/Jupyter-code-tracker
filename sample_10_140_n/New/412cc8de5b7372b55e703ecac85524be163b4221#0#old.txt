[{"block": 0, "type": "markdown", "linesLength": 1, "startIndex": 0, "lines": ["### 1. Global Settings"]}, {"block": 1, "type": "code", "linesLength": 17, "startIndex": 1, "lines": ["import sys\n", "sys.path.append(\"../../\")\n", "import json\n", "import os\n", "import surprise\n", "import papermill as pm\n", "import pandas as pd\n", "import shutil\n", "import time\n", "import yaml\n", "from reco_utils.dataset import movielens\n", "from reco_utils.dataset.python_splitters import python_random_split\n", "from reco_utils.evaluation.python_evaluation import rmse, precision_at_k, ndcg_at_k\n", "from reco_utils.recommender.surprise.surprise_utils import compute_rating_predictions, compute_ranking_predictions\n", "\n", "print(\"System version: {}\".format(sys.version))\n", "print(\"Surprise version: {}\".format(surprise.__version__))"]}, {"block": 2, "type": "markdown", "linesLength": 3, "startIndex": 18, "lines": ["### 2. Prepare Dataset\n", "1. Download data and split into training, validation and test sets\n", "2. Store the data sets to a local directory."]}, {"block": 3, "type": "code", "linesLength": 2, "startIndex": 21, "lines": ["# Select Movielens data size: 100k, 1m, 10m, or 20m\n", "MOVIELENS_DATA_SIZE = '100k'"]}, {"block": 4, "type": "code", "linesLength": 6, "startIndex": 23, "lines": ["data = movielens.load_pandas_df(\n", "    size=MOVIELENS_DATA_SIZE,\n", "    header=[\"userID\", \"itemID\", \"rating\"]\n", ")\n", "\n", "data.head()"]}, {"block": 5, "type": "code", "linesLength": 1, "startIndex": 29, "lines": ["train, validation, test = python_random_split(data, [0.7, 0.15, 0.15])"]}, {"block": 6, "type": "code", "linesLength": 11, "startIndex": 30, "lines": ["DATA_DIR = 'aml_data'\n", "os.makedirs(DATA_DIR, exist_ok=True)\n", "\n", "TRAIN_FILE_NAME = \"movielens_\" + MOVIELENS_DATA_SIZE + \"_train.pkl\"\n", "train.to_pickle(os.path.join(DATA_DIR, TRAIN_FILE_NAME))\n", "\n", "VAL_FILE_NAME = \"movielens_\" + MOVIELENS_DATA_SIZE + \"_val.pkl\"\n", "validation.to_pickle(os.path.join(DATA_DIR, VAL_FILE_NAME))\n", "\n", "TEST_FILE_NAME = \"movielens_\" + MOVIELENS_DATA_SIZE + \"_test.pkl\"\n", "test.to_pickle(os.path.join(DATA_DIR, TEST_FILE_NAME))"]}, {"block": 7, "type": "markdown", "linesLength": 1, "startIndex": 41, "lines": ["### 3. Prepare Hyperparameter Tuning "]}, {"block": 8, "type": "markdown", "linesLength": 2, "startIndex": 42, "lines": ["We now prepare a training script [svd_training_nni.py](../../reco_utils/nni/svd_training.py) for the hyperparameter tuning, which will log our target metrics such as precision, NDCG, RMSE.\n", "We define the arguments of the script and the search space for the hyperparameters. All the parameter values will be passed to our training script."]}, {"block": 9, "type": "code", "linesLength": 34, "startIndex": 44, "lines": ["EXP_NAME = \"movielens_\" + MOVIELENS_DATA_SIZE + \"_svd_model\"\n", "PRIMARY_METRIC = 'precision_at_k'\n", "RATING_METRICS = ['rmse']\n", "RANKING_METRICS = ['precision_at_k', 'ndcg_at_k']  \n", "USERCOL = 'userID'\n", "ITEMCOL = 'itemID'\n", "RECOMMEND_SEEN = False\n", "K = 10\n", "RANDOM_STATE = 0\n", "VERBOSE = True\n", "NUM_EPOCHS = 30\n", "BIASED = True\n", "\n", "script_params = \" \".join([\n", "    '--datastore', os.path.join(os.getcwd(), 'aml_data'),\n", "    '--train-datapath', TRAIN_FILE_NAME,\n", "    '--validation-datapath', VAL_FILE_NAME,\n", "    '--surprise-reader', 'ml-100k',\n", "    '--rating-metrics', \" \".join(RATING_METRICS),\n", "    '--ranking-metrics', \" \".join(RANKING_METRICS),\n", "    '--usercol', USERCOL,\n", "    '--itemcol', ITEMCOL,\n", "    '--k', str(K),\n", "    '--random-state', str(RANDOM_STATE),\n", "    '--epochs', str(NUM_EPOCHS),\n", "    '--primary-metric', PRIMARY_METRIC\n", "])\n", "\n", "if BIASED:\n", "    script_params += ' --biased'\n", "if VERBOSE:\n", "    script_params += ' --verbose'\n", "if RECOMMEND_SEEN:\n", "    script_params += ' --recommend-seen'"]}, {"block": 10, "type": "code", "linesLength": 16, "startIndex": 78, "lines": ["# hyperparameters search space\n", "# We do not set 'lr_all' and 'reg_all' because they will be overriden by the other lr_ and reg_ parameters\n", "\n", "hyper_params = {\n", "    'n_factors': {\"_type\": \"choice\", \"_value\": [10, 50, 100, 150, 200]},\n", "    'init_mean': {\"_type\": \"uniform\", \"_value\": [-0.5, 0.5]},\n", "    'init_std_dev': {\"_type\": \"uniform\", \"_value\": [0.01, 0.2]},\n", "    'lr_bu': {\"_type\": \"uniform\", \"_value\": [1e-6, 0.1]}, \n", "    'lr_bi': {\"_type\": \"uniform\", \"_value\": [1e-6, 0.1]}, \n", "    'lr_pu': {\"_type\": \"uniform\", \"_value\": [1e-6, 0.1]}, \n", "    'lr_qi': {\"_type\": \"uniform\", \"_value\": [1e-6, 0.1]}, \n", "    'reg_bu': {\"_type\": \"uniform\", \"_value\": [1e-6, 1]},\n", "    'reg_bi': {\"_type\": \"uniform\", \"_value\": [1e-6, 1]}, \n", "    'reg_pu': {\"_type\": \"uniform\", \"_value\": [1e-6, 1]}, \n", "    'reg_qi': {\"_type\": \"uniform\", \"_value\": [1e-6, 1]}\n", "}"]}, {"block": 11, "type": "code", "linesLength": 2, "startIndex": 94, "lines": ["with open('../../reco_utils/nni/search_space_svd.json', 'w') as fp:\n", "    json.dump(hyper_params, fp)"]}, {"block": 12, "type": "markdown", "linesLength": 1, "startIndex": 96, "lines": ["We also create a yaml file for the configuration of the trials and the tuning algorithm to be used (in this experiment we use TPE). The tuning trials will be executed locally on a [Standard_D16_v3 virtual machine](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sizes-general#dv3-series-1) (16 vcpus, 64 GB memory)."]}, {"block": 13, "type": "code", "linesLength": 27, "startIndex": 97, "lines": ["config = {\n", "    'authorName': 'default',\n", "    'experimentName': 'surprise_svd',\n", "    'trialConcurrency': 8,\n", "    'maxExecDuration': '1h',\n", "    'maxTrialNum': 100,\n", "    'trainingServicePlatform': 'local',\n", "    # The path to Search Space\n", "    'searchSpacePath': 'search_space_svd.json',\n", "    'useAnnotation': False,\n", "    'tuner': {\n", "        'builtinTunerName': 'TPE',\n", "        'classArgs': {\n", "            #choice: maximize, minimize\n", "            'optimize_mode': 'maximize'\n", "        }\n", "    },\n", "    # The path and the running command of trial\n", "    'trial':  {\n", "      'command': 'python3 svd_training.py' + \" \" + script_params,\n", "      'codeDir': '.',\n", "      'gpuNum': 0\n", "    }\n", "}\n", " \n", "with open('../../reco_utils/nni/config_svd.yml', 'w') as fp:\n", "    fp.write(yaml.dump(config, default_flow_style=False))"]}, {"block": 14, "type": "markdown", "linesLength": 12, "startIndex": 124, "lines": ["### 4. Execute NNI Trials\n", "\n", "The conda environment comes with NNI installed, which includes the command line tool `nnictl` for controlling and getting information about NNI experiments. <br>\n", "To start the NNI trials for tuning, execute the following command: <br>\n", "`nnictl create --config ../../reco_utils/nni/config_svd.yml` <br>\n", "You can see the progress of the experiment by using the URL links output by the above command.\n", "\n", "![](https://recodatasets.blob.core.windows.net/images/nn1.png)\n", "\n", "![](https://recodatasets.blob.core.windows.net/images/nn2.png)\n", "\n", "![](https://recodatasets.blob.core.windows.net/images/nn3.png)"]}, {"block": 15, "type": "markdown", "linesLength": 7, "startIndex": 136, "lines": ["### 5. Show Results\n", "\n", "The trial with the best metric and the corresponding metrics and hyperparameters can be read from the Web UI,\n", "\n", "![](https://recodatasets.blob.core.windows.net/images/nni4.png)\n", "\n", "or from the JSON file created by the training script."]}, {"block": 16, "type": "code", "linesLength": 2, "startIndex": 143, "lines": ["with open(\"/home/anargyri/nni/experiments/x4jGIDnF/trials/bbOnf/metrics.json\", \"r\") as fp:\n", "    best_run_metrics = json.load(fp)"]}, {"block": 17, "type": "code", "linesLength": 1, "startIndex": 145, "lines": ["best_run_metrics"]}, {"block": 18, "type": "code", "linesLength": 2, "startIndex": 146, "lines": ["with open(\"/home/anargyri/nni/experiments/x4jGIDnF/trials/bbOnf/parameter.cfg\", \"r\") as fp:\n", "    parameter_values = json.load(fp)"]}, {"block": 19, "type": "code", "linesLength": 1, "startIndex": 148, "lines": ["parameter_values[\"parameters\"]"]}, {"block": 20, "type": "markdown", "linesLength": 1, "startIndex": 149, "lines": ["Now we evaluate the metrics on the test data. To do this, we get the SVD model that was saved as `model.dump` in the training script."]}, {"block": 21, "type": "code", "linesLength": 1, "startIndex": 150, "lines": ["svd = surprise.dump.load(\"/home/anargyri/nni/experiments/x4jGIDnF/trials/bbOnf/model.dump\")[1]"]}, {"block": 22, "type": "code", "linesLength": 10, "startIndex": 151, "lines": ["def compute_test_results(svd):\n", "    test_results = {}\n", "    predictions = compute_rating_predictions(svd, test, usercol=\"userID\", itemcol=\"itemID\")\n", "    for metric in RATING_METRICS:\n", "        test_results[metric] = eval(metric)(test, predictions)\n", "\n", "    all_predictions = compute_ranking_predictions(svd, train, usercol=\"userID\", itemcol=\"itemID\", recommend_seen=RECOMMEND_SEEN)\n", "    for metric in RANKING_METRICS:\n", "        test_results[metric] = eval(metric)(test, all_predictions, col_prediction='prediction', k=K)\n", "    return test_results"]}, {"block": 23, "type": "code", "linesLength": 2, "startIndex": 161, "lines": ["test_results_tpe = compute_test_results(svd)\n", "print(test_results_tpe)"]}, {"block": 24, "type": "markdown", "linesLength": 2, "startIndex": 163, "lines": ["### 6. More Tuning Algorithms\n", "We now apply other tuning algorithms supported by NNI to the same problem. The only change needed is in the relevant entry of the configuration file."]}, {"block": 25, "type": "code", "linesLength": 4, "startIndex": 165, "lines": ["config['tuner']['builtinTunerName'] = 'Random'\n", " \n", "with open('../../reco_utils/nni/config_svd.yml', 'w') as fp:\n", "    fp.write(yaml.dump(config, default_flow_style=False))"]}, {"block": 26, "type": "markdown", "linesLength": 1, "startIndex": 169, "lines": ["`nnictl create --config ../../reco_utils/nni/config_svd.yml`"]}, {"block": 27, "type": "code", "linesLength": 2, "startIndex": 170, "lines": ["svd = surprise.dump.load(\"/home/anargyri/nni/experiments/zJRSLc3r/trials/yowVo/model.dump\")[1]\n", "test_results_random = compute_test_results(svd)"]}, {"block": 28, "type": "code", "linesLength": 4, "startIndex": 172, "lines": ["config['tuner']['builtinTunerName'] = 'Anneal'\n", " \n", "with open('../../reco_utils/nni/config_svd.yml', 'w') as fp:\n", "    fp.write(yaml.dump(config, default_flow_style=False))"]}, {"block": 29, "type": "markdown", "linesLength": 1, "startIndex": 176, "lines": ["`nnictl create --config ../../reco_utils/nni/config_svd.yml`"]}, {"block": 30, "type": "code", "linesLength": 2, "startIndex": 177, "lines": ["svd = surprise.dump.load(\"/home/anargyri/nni/experiments/iF7mHmTz/trials/xvupt/model.dump\")[1]\n", "test_results_anneal = compute_test_results(svd)"]}, {"block": 31, "type": "code", "linesLength": 4, "startIndex": 179, "lines": ["config['tuner']['builtinTunerName'] = 'Evolution'\n", " \n", "with open('../../reco_utils/nni/config_svd.yml', 'w') as fp:\n", "    fp.write(yaml.dump(config, default_flow_style=False))"]}, {"block": 32, "type": "markdown", "linesLength": 1, "startIndex": 183, "lines": ["`nnictl create --config ../../reco_utils/nni/config_svd.yml`"]}, {"block": 33, "type": "code", "linesLength": 2, "startIndex": 184, "lines": ["svd = surprise.dump.load(\"/home/anargyri/nni/experiments/ROmbJkZY/trials/rdWWM/model.dump\")[1]\n", "test_results_evolution = compute_test_results(svd)"]}, {"block": 34, "type": "markdown", "linesLength": 2, "startIndex": 186, "lines": ["The SMAC tuner requires to be installed with the following command <br>\n", "`nnictl package install --name=SMAC`"]}, {"block": 35, "type": "code", "linesLength": 4, "startIndex": 188, "lines": ["config['tuner']['builtinTunerName'] = 'SMAC'\n", " \n", "with open('../../reco_utils/nni/config_svd.yml', 'w') as fp:\n", "    fp.write(yaml.dump(config, default_flow_style=False))"]}, {"block": 36, "type": "markdown", "linesLength": 1, "startIndex": 192, "lines": ["`nnictl create --config ../../reco_utils/nni/config_svd.yml`"]}, {"block": 37, "type": "code", "linesLength": 2, "startIndex": 193, "lines": ["svd = surprise.dump.load(\"/home/anargyri/nni/experiments/Fkcy07gq/trials/fQD9d/model.dump\")[1]\n", "test_results_smac = compute_test_results(svd)"]}, {"block": 38, "type": "code", "linesLength": 4, "startIndex": 195, "lines": ["config['tuner']['builtinTunerName'] = 'Hyperband'\n", " \n", "with open('../../reco_utils/nni/config_svd.yml', 'w') as fp:\n", "    fp.write(yaml.dump(config, default_flow_style=False))"]}, {"block": 39, "type": "markdown", "linesLength": 1, "startIndex": 199, "lines": ["`nnictl create --config ../../reco_utils/nni/config_svd.yml`"]}, {"block": 40, "type": "code", "linesLength": 2, "startIndex": 200, "lines": ["svd = surprise.dump.load(\"/home/anargyri/nni/experiments//trials//model.dump\")[1]\n", "test_results_hyperband = compute_test_results(svd)"]}, {"block": 41, "type": "code", "linesLength": 4, "startIndex": 202, "lines": ["config['tuner']['builtinTunerName'] = 'MetisTuner'\n", " \n", "with open('../../reco_utils/nni/config_svd.yml', 'w') as fp:\n", "    fp.write(yaml.dump(config, default_flow_style=False))"]}, {"block": 42, "type": "markdown", "linesLength": 1, "startIndex": 206, "lines": ["`nnictl create --config ../../reco_utils/nni/config_svd.yml`"]}, {"block": 43, "type": "code", "linesLength": 2, "startIndex": 207, "lines": ["svd = surprise.dump.load(\"/home/anargyri/nni/experiments/CFq9BgQp/trials/hlaL8/model.dump\")[1]\n", "test_results_metis = compute_test_results(svd)"]}, {"block": 44, "type": "code", "linesLength": 5, "startIndex": 209, "lines": ["pd.DataFrame(index=['TPE', 'Random Search', 'Annealing', 'Evolution', 'SMAC', 'Metis'],\n", "             data=[res['precision_at_k'] for res in [test_results_tpe, test_results_random, test_results_anneal, \n", "                                                     test_results_evolution, test_results_smac, test_results_metis]], \n", "             columns=['precision@{}'.format(K)]\n", "            ).sort_values(by='precision@{}'.format(K), ascending=False)"]}, {"block": 45, "type": "code", "linesLength": 4, "startIndex": 214, "lines": ["try:\n", "    shutil.rmtree(DATA_DIR)\n", "except (PermissionError, FileNotFoundError):\n", "    pass"]}, {"block": 46, "type": "markdown", "linesLength": 4, "startIndex": 218, "lines": ["### 7. Concluding Remarks\n", "\n", "We showed how to tune **all** the hyperparameters accepted by Surprise SVD simultaneously, by utilizing the NNI toolkit. \n", "For example, training and evaluation of a single SVD model takes about 50 seconds on the 100k MovieLens data on a Standard D2_V2 VM. Searching through 100 different combinations of hyperparameters sequentially would take about 80 minutes whereas each of the above experiments took about 10. With NNI, one can take advantage of concurrency and multiple proessors on a virtual machine and use various methods to navigate efficiently through a large space of hyperparameters."]}, {"block": 47, "type": "markdown", "linesLength": 5, "startIndex": 222, "lines": ["### References\n", "\n", "* [Matrix factorization algorithms in Surprise](https://surprise.readthedocs.io/en/stable/matrix_factorization.html) \n", "* [Surprise SVD deep-dive notebook](../02_model/surprise_svd_deep_dive.ipynb)\n", "* [Neural Network Intelligence toolkit](https://github.com/Microsoft/nni)"]}]
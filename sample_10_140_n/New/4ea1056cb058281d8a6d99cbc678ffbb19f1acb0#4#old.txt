[{"block": 0, "type": "markdown", "linesLength": 7, "startIndex": 0, "lines": ["##ThinkDSP\n", "\n", "This notebook contains code examples from Chapter 10: Signals and Systems\n", "\n", "Copyright 2015 Allen Downey\n", "\n", "License: [Creative Commons Attribution 4.0 International](http://creativecommons.org/licenses/by/4.0/)"]}, {"block": 1, "type": "code", "linesLength": 13, "startIndex": 7, "lines": ["from __future__ import print_function, division\n", "\n", "import thinkdsp\n", "import thinkplot\n", "import math\n", "import numpy as np\n", "import pandas\n", "import scipy.signal\n", "\n", "PI2 = 2 * math.pi\n", "\n", "%precision 3\n", "%matplotlib inline"]}, {"block": 2, "type": "markdown", "linesLength": 1, "startIndex": 20, "lines": ["Here's a recording of a gunshot, which approximates the acoustic impulse response of the room:"]}, {"block": 3, "type": "code", "linesLength": 5, "startIndex": 21, "lines": ["response = thinkdsp.read_wave('180961__kleeb__gunshots.wav')\n", "response = response.segment(start=0.26, duration=5.0)\n", "response.normalize()\n", "response.plot()\n", "thinkplot.config(ylim=[-1.05, 1.05], legend=False)"]}, {"block": 4, "type": "markdown", "linesLength": 1, "startIndex": 26, "lines": ["Here's what it sounds like:"]}, {"block": 5, "type": "code", "linesLength": 1, "startIndex": 27, "lines": ["response.make_audio()"]}, {"block": 6, "type": "markdown", "linesLength": 1, "startIndex": 28, "lines": ["The DFT of the impulse response is the transfer function:"]}, {"block": 7, "type": "code", "linesLength": 2, "startIndex": 29, "lines": ["transfer = response.make_spectrum()\n", "transfer.plot()"]}, {"block": 8, "type": "markdown", "linesLength": 1, "startIndex": 31, "lines": ["Here's the transfer function on a log-log scale:"]}, {"block": 9, "type": "code", "linesLength": 2, "startIndex": 32, "lines": ["transfer.plot()\n", "thinkplot.config(xscale='log', yscale='log')"]}, {"block": 10, "type": "markdown", "linesLength": 1, "startIndex": 34, "lines": ["Now we can simulate what a recording would sound like if it were played in the same room and recorded in the same way.  Here's the violin recording we have used before:"]}, {"block": 11, "type": "code", "linesLength": 5, "startIndex": 35, "lines": ["violin = thinkdsp.read_wave('92002__jcveliz__violin-origional.wav')\n", "violin.ys = violin.ys[:len(response)]\n", "violin.normalize()\n", "violin.plot()\n", "thinkplot.config(ylim=[-1.05, 1.05])"]}, {"block": 12, "type": "markdown", "linesLength": 1, "startIndex": 40, "lines": ["Here's what it sounds like before transformation:"]}, {"block": 13, "type": "code", "linesLength": 1, "startIndex": 41, "lines": ["violin.make_audio()"]}, {"block": 14, "type": "markdown", "linesLength": 1, "startIndex": 42, "lines": ["Now we compute the DFT of the violin recording."]}, {"block": 15, "type": "code", "linesLength": 1, "startIndex": 43, "lines": ["spectrum = violin.make_spectrum()"]}, {"block": 16, "type": "markdown", "linesLength": 1, "startIndex": 44, "lines": ["I trimmed the violin recording to the same length as the impulse response:"]}, {"block": 17, "type": "code", "linesLength": 1, "startIndex": 45, "lines": ["len(spectrum.hs), len(transfer.hs)"]}, {"block": 18, "type": "markdown", "linesLength": 1, "startIndex": 46, "lines": ["We we can multiply in the frequency domain and the transform back to the time domain."]}, {"block": 19, "type": "code", "linesLength": 2, "startIndex": 47, "lines": ["output = (spectrum * transfer).make_wave()\n", "output.normalize()"]}, {"block": 20, "type": "markdown", "linesLength": 1, "startIndex": 49, "lines": ["Here'a  comparison of the original and transformed recordings:"]}, {"block": 21, "type": "code", "linesLength": 2, "startIndex": 50, "lines": ["violin.plot()\n", "output.plot()"]}, {"block": 22, "type": "markdown", "linesLength": 1, "startIndex": 52, "lines": ["And here's what it sounds like:"]}, {"block": 23, "type": "code", "linesLength": 1, "startIndex": 53, "lines": ["output.make_audio()"]}, {"block": 24, "type": "markdown", "linesLength": 1, "startIndex": 54, "lines": ["To understand how that worked, you can think about the input signal as a series of impulses, and the output as the sume of shifted, scaled versions of the impulse response."]}, {"block": 25, "type": "code", "linesLength": 5, "startIndex": 55, "lines": ["def shifted_scaled(wave, shift, factor):\n", "    res = wave.copy()\n", "    res.shift(shift)\n", "    res.scale(factor)\n", "    return res"]}, {"block": 26, "type": "markdown", "linesLength": 1, "startIndex": 60, "lines": ["Here's what it would sound like if we fired a big gun followed by a small gun:"]}, {"block": 27, "type": "code", "linesLength": 7, "startIndex": 61, "lines": ["dt = 1\n", "shift = dt * response.framerate\n", "factor = 0.5\n", "\n", "response2 = response + shifted_scaled(response, shift, factor)\n", "response2.plot()\n", "thinkplot.config(xlabel='time (s)', ylabel='amplitude', ylim=[-1.05, 1.05])"]}, {"block": 28, "type": "markdown", "linesLength": 1, "startIndex": 68, "lines": ["Two gunshots:"]}, {"block": 29, "type": "code", "linesLength": 1, "startIndex": 69, "lines": ["response2.make_audio()"]}, {"block": 30, "type": "markdown", "linesLength": 1, "startIndex": 70, "lines": ["Here's what it sounds like if we fire 100 guns at a rate of 441 gunshots per second:"]}, {"block": 31, "type": "code", "linesLength": 4, "startIndex": 71, "lines": ["total = 0\n", "for j in range(100):\n", "    total += shifted_scaled(response, j*100, 1.0)\n", "total.normalize()"]}, {"block": 32, "type": "markdown", "linesLength": 0, "startIndex": 75, "lines": []}, {"block": 33, "type": "code", "linesLength": 1, "startIndex": 75, "lines": ["total.make_audio()"]}, {"block": 34, "type": "markdown", "linesLength": 1, "startIndex": 76, "lines": ["The result has a fundamental frequency at 441, with additional harmonics."]}, {"block": 35, "type": "code", "linesLength": 1, "startIndex": 77, "lines": ["total.make_spectrum().plot(high=8000)"]}, {"block": 36, "type": "markdown", "linesLength": 1, "startIndex": 78, "lines": ["Now let's do the same thing with a sawtooth signal:"]}, {"block": 37, "type": "code", "linesLength": 3, "startIndex": 79, "lines": ["sawtooth = thinkdsp.SawtoothSignal(freq=410).make_wave(duration=0.2, framerate=response.framerate)\n", "sawtooth.plot()\n", "thinkplot.config(xlabel='time (s)', ylabel='amplitude', ylim=[-1.05, 1.05])"]}, {"block": 38, "type": "markdown", "linesLength": 1, "startIndex": 82, "lines": ["Here's what it sounds like:"]}, {"block": 39, "type": "code", "linesLength": 1, "startIndex": 83, "lines": ["sawtooth.make_audio()"]}, {"block": 40, "type": "markdown", "linesLength": 1, "startIndex": 84, "lines": ["And here's what we get if we use the sawtooth to generate shifted, scaled versions of the impulse response:"]}, {"block": 41, "type": "code", "linesLength": 4, "startIndex": 85, "lines": ["total = 0\n", "for j, y in enumerate(sawtooth.ys):\n", "    total += shifted_scaled(response, j, y)\n", "total.normalize()"]}, {"block": 42, "type": "markdown", "linesLength": 1, "startIndex": 89, "lines": ["The result is a simulation of what the sawtooth signal would sound like if it was recorded in the room where the gunshot was recorded:"]}, {"block": 43, "type": "code", "linesLength": 2, "startIndex": 90, "lines": ["total.plot()\n", "thinkplot.config(xlabel='time (s)', ylabel='amplitude', ylim=[-1.05, 1.05])"]}, {"block": 44, "type": "markdown", "linesLength": 1, "startIndex": 92, "lines": ["And here's what it sounds like:"]}, {"block": 45, "type": "code", "linesLength": 1, "startIndex": 93, "lines": ["total.make_audio()"]}, {"block": 46, "type": "markdown", "linesLength": 3, "startIndex": 94, "lines": ["To me it sounds a bit like a car horn in a garage.\n", "\n", "And here's the spectrum:"]}, {"block": 47, "type": "code", "linesLength": 1, "startIndex": 97, "lines": ["total.make_spectrum().plot(high=8000)"]}, {"block": 48, "type": "markdown", "linesLength": 1, "startIndex": 98, "lines": ["Here's a comparison before and after convolution:"]}, {"block": 49, "type": "code", "linesLength": 5, "startIndex": 99, "lines": ["sawtooth.make_spectrum().plot(high=500, color='0.7')\n", "\n", "segment = total.segment(duration=0.2)\n", "segment.make_spectrum().plot(high=1000)\n", "thinkplot.config(xlabel='frequency (Hz)', ylabel='amplitude')"]}, {"block": 50, "type": "markdown", "linesLength": 1, "startIndex": 104, "lines": ["Now that we recognize this operation as convolution, we can compute it using the convolve method:"]}, {"block": 51, "type": "code", "linesLength": 3, "startIndex": 105, "lines": ["convolved = sawtooth.convolve(response)\n", "convolved.normalize()\n", "convolved.make_audio()"]}, {"block": 52, "type": "markdown", "linesLength": 1, "startIndex": 108, "lines": ["And we can do the same thing with the violin recording:"]}, {"block": 53, "type": "code", "linesLength": 3, "startIndex": 109, "lines": ["convolved2 = violin.convolve(response)\n", "convolved2.normalize()\n", "convolved2.make_audio()"]}, {"block": 54, "type": "markdown", "linesLength": 1, "startIndex": 112, "lines": ["To understand why the impulse response is sufficient to characterize a system, it is informative to look at the DFT of an impulse:"]}, {"block": 55, "type": "code", "linesLength": 3, "startIndex": 113, "lines": ["impulse = np.zeros(8)\n", "impulse[0] = 1\n", "print(impulse)"]}, {"block": 56, "type": "markdown", "linesLength": 1, "startIndex": 116, "lines": ["The DFT of an impulse is all ones, which means that the impulse contains equal energy at all frequencies.  So testing a system with an impulse is like testing it will all frequency components at the same time:"]}, {"block": 57, "type": "code", "linesLength": 2, "startIndex": 117, "lines": ["spectrum = np.fft.fft(impulse)\n", "print(spectrum)"]}, {"block": 58, "type": "markdown", "linesLength": 1, "startIndex": 119, "lines": ["You might notice something about the impulse and its DFT:"]}, {"block": 59, "type": "code", "linesLength": 1, "startIndex": 120, "lines": ["np.sum(np.absolute(impulse)**2)"]}, {"block": 60, "type": "code", "linesLength": 1, "startIndex": 121, "lines": ["np.sum(np.absolute(spectrum)**2)"]}, {"block": 61, "type": "markdown", "linesLength": 3, "startIndex": 122, "lines": ["In general, the total magnitue of DFT(y) is N times the total magnitude of y.\n", "\n", "Finally, let's look at a mini example of system characterization.  Suppose you have a system that smooths the signal by taking a moving average of adjacent elements:"]}, {"block": 62, "type": "code", "linesLength": 1, "startIndex": 125, "lines": ["window = np.array([0.5, 0.5, 0, 0, 0, 0, 0, 0,])"]}, {"block": 63, "type": "markdown", "linesLength": 1, "startIndex": 126, "lines": ["For this moving average window, we can compute the transfer function:"]}, {"block": 64, "type": "code", "linesLength": 2, "startIndex": 127, "lines": ["filtr = scipy.fftpack.fft(window)\n", "filtr"]}, {"block": 65, "type": "markdown", "linesLength": 1, "startIndex": 129, "lines": ["Here are the magnitudes:"]}, {"block": 66, "type": "code", "linesLength": 1, "startIndex": 130, "lines": ["np.absolute(filtr)"]}, {"block": 67, "type": "markdown", "linesLength": 1, "startIndex": 131, "lines": ["To visualize the transfer function, I'll roll it so that frequency 0 is in the middle.  The DFT of a smoothing window is approximately Gaussian:"]}, {"block": 68, "type": "code", "linesLength": 2, "startIndex": 132, "lines": ["rolled = np.roll(filtr, 3)\n", "thinkplot.plot([-3, -2, -1, 0, 1, 2, 3, 4], rolled.real)"]}, {"block": 69, "type": "markdown", "linesLength": 1, "startIndex": 134, "lines": ["If you multiply the transfer function by the spectrum of an impulse (which is all ones), the result is the filter:"]}, {"block": 70, "type": "code", "linesLength": 2, "startIndex": 135, "lines": ["product = spectrum * filtr\n", "print(product)"]}, {"block": 71, "type": "markdown", "linesLength": 1, "startIndex": 137, "lines": ["Now if you transform back to the time domain, you have the impulse response, which looks a lot like the window:"]}, {"block": 72, "type": "code", "linesLength": 2, "startIndex": 138, "lines": ["filtered = scipy.fftpack.ifft(product)\n", "thinkplot.plot(filtered.real)"]}, {"block": 73, "type": "code", "linesLength": 1, "startIndex": 140, "lines": ["print(filtered.real)"]}, {"block": 74, "type": "markdown", "linesLength": 1, "startIndex": 141, "lines": ["This example is meant to demonstrate why a recording of an impulse response is sufficient to characterize a system: because it is the IDFT of the transfer function."]}, {"block": 75, "type": "code", "linesLength": 0, "startIndex": 142, "lines": []}]